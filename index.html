<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morocco Map</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .atlas-container { overflow: hidden; -ms-touch-action: none; touch-action: none; position: relative; background: #ddd; outline: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .atlas-container *, .atlas-container *:after, .atlas-container *:before { box-sizing: border-box; margin: 0; padding: 0; }
        .atlas-pane, .atlas-tile, .atlas-marker-icon, .atlas-marker-shadow, .atlas-tile-container, .atlas-map-pane { position: absolute; left: 0; top: 0; }
        .atlas-container { cursor: grab; }
        .atlas-container.atlas-drag-target { cursor: grabbing; }
        .atlas-dragging { cursor: grabbing; }
        .atlas-tile { mix-blend-mode: normal; filter: inherit; visibility: hidden; user-select: none; backface-visibility: hidden; transform: translateZ(0); }
        .atlas-tile-loaded { visibility: inherit; }
        .atlas-tile-fade { opacity: 0; transition: opacity 0.2s linear; }
        .atlas-tile-fade.atlas-tile-loaded { opacity: 1; }
        .atlas-zoom-anim .atlas-zoom-animated { will-change: transform; transition: transform 0.25s cubic-bezier(0,0,0.25,1); }
        .atlas-zoom-anim .atlas-tile { transition: none; } 
        .atlas-zoom-anim .atlas-zoom-hide { visibility: hidden; }
        .atlas-map-pane { z-index: auto; transform-origin: 0 0; }
        .atlas-tile-pane { z-index: 200; }
        .atlas-overlay-pane { z-index: 400; pointer-events: none; }
        .atlas-shadow-pane { z-index: 500; }
        .atlas-marker-pane { z-index: 600; }
        .atlas-popup-pane { z-index: 700; }
        .atlas-tooltip-pane { z-index: 800; }
        .atlas-control-container { z-index: 1000; position: relative; pointer-events: none; }
        .atlas-top, .atlas-bottom { position: absolute; z-index: 1000; pointer-events: none; }
        .atlas-top { top: 0; }
        .atlas-right { right: 0; }
        .atlas-bottom { bottom: 0; }
        .atlas-left { left: 0; }
        .atlas-control { float: left; clear: both; pointer-events: auto; margin: 10px; background: #fff; border: 2px solid rgba(0,0,0,0.2); background-clip: padding-box; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); }
        .atlas-right .atlas-control { float: right; }
        .atlas-control-zoom a { width: 30px; height: 30px; line-height: 30px; font-size: 22px; font-weight: bold; text-align: center; text-decoration: none; color: black; display: block; }
        .atlas-control-zoom a:hover { background-color: #f4f4f4; }
        .atlas-control-zoom a:first-child { border-bottom: 1px solid #ccc; border-radius: 4px 4px 0 0; }
        .atlas-control-zoom a:last-child { border-radius: 0 0 4px 4px; }
        .atlas-control-attribution { background: rgba(255, 255, 255, 0.8); margin: 0; padding: 0 5px; font-size: 11px; color: #333; border: none; border-radius: 0; box-shadow: none; }
        .atlas-control-scale { background: rgba(255, 255, 255, 0.8); font-size: 11px; text-align: center; margin: 5px; padding: 2px 5px 3px; border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; white-space: nowrap; overflow: hidden; min-width: 50px; }
        .atlas-control-scale-line { border-bottom: 2px solid rgba(0,0,0,0.5); width: 100%; height: 0; }
        .atlas-marker-icon { display: block; user-select: none; pointer-events: none; }
        .atlas-marker-draggable { cursor: move; pointer-events: auto; }
        .atlas-default-icon-pin { width: 30px; height: 30px; background: #2980b9; border-radius: 50% 50% 0; transform: rotate(-45deg); position: absolute; left: 0; top: 0; border: 2px solid white; box-shadow: 1px 1px 4px rgba(0,0,0,0.3); }
        .atlas-default-icon-dot { width: 8px; height: 8px; background: white; border-radius: 50%; position: absolute; left: 11px; top: 11px; z-index: 1; }
        .atlas-popup { position: absolute; text-align: center; margin-bottom: 20px; pointer-events: auto; }
        .atlas-popup-content-wrapper { padding: 1px; text-align: left; border-radius: 12px; background: white; box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
        .atlas-popup-content { margin: 13px 19px; line-height: 1.4; }
        .atlas-popup-tip-container { width: 40px; height: 20px; position: absolute; left: 50%; margin-left: -20px; overflow: hidden; pointer-events: none; }
        .atlas-popup-tip { width: 17px; height: 17px; padding: 1px; margin: -10px auto 0; background: white; transform: rotate(45deg); box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
        .atlas-popup-close-button { position: absolute; top: 0; right: 0; padding: 4px 4px 0 0; text-align: center; width: 18px; height: 14px; font: 16px/14px Tahoma, Verdana, sans-serif; color: #c3c3c3; text-decoration: none; font-weight: bold; background: transparent; }
        .atlas-popup-close-button:hover { color: #999; }
        .atlas-overlay-pane svg { pointer-events: none; }
        .atlas-overlay-pane path { pointer-events: auto; }
        .atlas-tooltip { position: absolute; padding: 6px; background: #fff; border: 1px solid #ccc; border-radius: 3px; white-space: nowrap; pointer-events: none; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .atlas-touch .atlas-dragging { user-select: none; }
        .atlas-container.touching { user-select: none; cursor: grabbing !important; }
        .atlas-container.touching .atlas-control { pointer-events: none; }
        .atlas-container .atlas-loader { position: absolute; top: 50%; left: 50%; margin: -16px 0 0 -16px; width: 32px; height: 32px; pointer-events: none; }
        .atlas-container .atlas-loader:after { content: " "; display: block; width: 24px; height: 24px; margin: 4px; border-radius: 50%; border: 3px solid #3388ff; border-color: #3388ff transparent #3388ff transparent; animation: atlas-loader-spin 1.2s linear infinite; }
        @keyframes atlas-loader-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        (function (window, document, undefined) {
            'use strict';
            var Atlas = { version: '2.0.2' };

            function expose() {
                var oldAtlas = window.Atlas;
                Atlas.noConflict = function () {
                    window.Atlas = oldAtlas;
                    return this;
                };
                window.Atlas = Atlas;
            }

            Atlas.injectCSS = function () {
                var css = `
                .atlas-container { overflow: hidden; -ms-touch-action: none; touch-action: none; position: relative; background: #ddd; outline: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
                .atlas-container *, .atlas-container *:after, .atlas-container *:before { box-sizing: border-box; margin: 0; padding: 0; }
                .atlas-pane, .atlas-tile, .atlas-marker-icon, .atlas-marker-shadow, .atlas-tile-container, .atlas-map-pane { position: absolute; left: 0; top: 0; }
                .atlas-container { cursor: grab; }
                .atlas-container.atlas-drag-target { cursor: grabbing; }
                .atlas-dragging { cursor: grabbing; }
                .atlas-tile { mix-blend-mode: normal; filter: inherit; visibility: hidden; user-select: none; backface-visibility: hidden; transform: translateZ(0); }
                .atlas-tile-loaded { visibility: inherit; }
                .atlas-tile-fade { opacity: 0; transition: opacity 0.2s linear; }
                .atlas-tile-fade.atlas-tile-loaded { opacity: 1; }
                .atlas-zoom-anim .atlas-zoom-animated { will-change: transform; transition: transform 0.25s cubic-bezier(0,0,0.25,1); }
                .atlas-zoom-anim .atlas-tile { transition: none; } 
                .atlas-zoom-anim .atlas-zoom-hide { visibility: hidden; }
                .atlas-map-pane { z-index: auto; transform-origin: 0 0; }
                .atlas-tile-pane { z-index: 200; }
                .atlas-overlay-pane { z-index: 400; pointer-events: none; }
                .atlas-shadow-pane { z-index: 500; }
                .atlas-marker-pane { z-index: 600; }
                .atlas-popup-pane { z-index: 700; }
                .atlas-tooltip-pane { z-index: 800; }
                .atlas-control-container { z-index: 1000; position: relative; pointer-events: none; }
                .atlas-top, .atlas-bottom { position: absolute; z-index: 1000; pointer-events: none; }
                .atlas-top { top: 0; }
                .atlas-right { right: 0; }
                .atlas-bottom { bottom: 0; }
                .atlas-left { left: 0; }
                .atlas-control { float: left; clear: both; pointer-events: auto; margin: 10px; background: #fff; border: 2px solid rgba(0,0,0,0.2); background-clip: padding-box; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); }
                .atlas-right .atlas-control { float: right; }
                .atlas-control-zoom a { width: 30px; height: 30px; line-height: 30px; font-size: 22px; font-weight: bold; text-align: center; text-decoration: none; color: black; display: block; }
                .atlas-control-zoom a:hover { background-color: #f4f4f4; }
                .atlas-control-zoom a:first-child { border-bottom: 1px solid #ccc; border-radius: 4px 4px 0 0; }
                .atlas-control-zoom a:last-child { border-radius: 0 0 4px 4px; }
                .atlas-control-attribution { background: rgba(255, 255, 255, 0.8); margin: 0; padding: 0 5px; font-size: 11px; color: #333; border: none; border-radius: 0; box-shadow: none; }
                .atlas-control-scale { background: rgba(255, 255, 255, 0.8); font-size: 11px; text-align: center; margin: 5px; padding: 2px 5px 3px; border: 1px solid rgba(0,0,0,0.2); border-radius: 3px; white-space: nowrap; overflow: hidden; min-width: 50px; }
                .atlas-control-scale-line { border-bottom: 2px solid rgba(0,0,0,0.5); width: 100%; height: 0; }
                .atlas-marker-icon { display: block; user-select: none; pointer-events: none; }
                .atlas-marker-draggable { cursor: move; pointer-events: auto; }
                .atlas-default-icon-pin { width: 30px; height: 30px; background: #2980b9; border-radius: 50% 50% 0; transform: rotate(-45deg); position: absolute; left: 0; top: 0; border: 2px solid white; box-shadow: 1px 1px 4px rgba(0,0,0,0.3); }
                .atlas-default-icon-dot { width: 8px; height: 8px; background: white; border-radius: 50%; position: absolute; left: 11px; top: 11px; z-index: 1; }
                .atlas-popup { position: absolute; text-align: center; margin-bottom: 20px; pointer-events: auto; }
                .atlas-popup-content-wrapper { padding: 1px; text-align: left; border-radius: 12px; background: white; box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
                .atlas-popup-content { margin: 13px 19px; line-height: 1.4; }
                .atlas-popup-tip-container { width: 40px; height: 20px; position: absolute; left: 50%; margin-left: -20px; overflow: hidden; pointer-events: none; }
                .atlas-popup-tip { width: 17px; height: 17px; padding: 1px; margin: -10px auto 0; background: white; transform: rotate(45deg); box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
                .atlas-popup-close-button { position: absolute; top: 0; right: 0; padding: 4px 4px 0 0; text-align: center; width: 18px; height: 14px; font: 16px/14px Tahoma, Verdana, sans-serif; color: #c3c3c3; text-decoration: none; font-weight: bold; background: transparent; }
                .atlas-popup-close-button:hover { color: #999; }
                .atlas-overlay-pane svg { pointer-events: none; }
                .atlas-overlay-pane path { pointer-events: auto; }
                .atlas-tooltip { position: absolute; padding: 6px; background: #fff; border: 1px solid #ccc; border-radius: 3px; white-space: nowrap; pointer-events: none; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
                .atlas-touch .atlas-dragging { user-select: none; }
                .atlas-container.touching { user-select: none; cursor: grabbing !important; }
                .atlas-container.touching .atlas-control { pointer-events: none; }
                .atlas-container .atlas-loader { position: absolute; top: 50%; left: 50%; margin: -16px 0 0 -16px; width: 32px; height: 32px; pointer-events: none; }
                .atlas-container .atlas-loader:after { content: " "; display: block; width: 24px; height: 24px; margin: 4px; border-radius: 50%; border: 3px solid #3388ff; border-color: #3388ff transparent #3388ff transparent; animation: atlas-loader-spin 1.2s linear infinite; }
                @keyframes atlas-loader-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                `;
                var style = document.createElement('style');
                style.type = 'text/css';
                if (style.styleSheet) style.styleSheet.cssText = css;
                else style.appendChild(document.createTextNode(css));
                document.head.appendChild(style);
            };
            Atlas.injectCSS();

            Atlas.Util = {
                extend: function (dest) {
                    var i, j, len, src;
                    for (j = 1, len = arguments.length; j < len; j++) {
                        src = arguments[j];
                        for (i in src) { dest[i] = src[i]; }
                    }
                    return dest;
                },
                create: Object.create || (function () {
                    function F() {}
                    return function (proto) {
                        F.prototype = proto;
                        return new F();
                    };
                })(),
                bind: function (fn, obj) {
                    var slice = Array.prototype.slice;
                    if (fn.bind) return fn.bind.apply(fn, slice.call(arguments, 1));
                    var args = slice.call(arguments, 2);
                    return function () {
                        return fn.apply(obj, args.length ? args.concat(slice.call(arguments)) : arguments);
                    };
                },
                stamp: function (obj) {
                    obj._atlas_id = obj._atlas_id || ++Atlas.Util.lastId;
                    return obj._atlas_id;
                },
                lastId: 0,
                throttle: function (fn, time, context) {
                    var lock, args, wrapperFn, later;
                    later = function () {
                        lock = false;
                        if (args) { wrapperFn.apply(context, args); args = false; }
                    };
                    wrapperFn = function () {
                        if (lock) { args = arguments; } 
                        else { fn.apply(context, arguments); setTimeout(later, time); lock = true; }
                    };
                    return wrapperFn;
                },
                wrapNum: function (x, range, includeMax) {
                    var max = range[1], min = range[0], d = max - min;
                    return x === max && includeMax ? x : ((x - min) % d + d) % d + min;
                },
                falseFn: function () { return false; },
                formatNum: function (num, digits) {
                    var pow = Math.pow(10, digits || 5);
                    return Math.round(num * pow) / pow;
                },
                trim: function (str) {
                    return str.trim ? str.trim() : str.replace(/^\s+|\s+$/g, '');
                },
                splitWords: function (str) {
                    return Atlas.Util.trim(str).split(/\s+/);
                },
                setOptions: function (obj, options) {
                    if (!obj.hasOwnProperty('options')) {
                        obj.options = obj.options ? Atlas.Util.create(obj.options) : {};
                    }
                    for (var i in options) { obj.options[i] = options[i]; }
                    return obj.options;
                },
                template: function (str, data) {
                    return str.replace(/\{ *([\w_]+) *\}/g, function (str, key) {
                        var value = data[key];
                        if (value === undefined) throw new Error('No value provided for variable ' + str);
                        return typeof value === 'function' ? value(data) : value;
                    });
                },
                isArray: Array.isArray || function (obj) {
                    return (Object.prototype.toString.call(obj) === '[object Array]');
                },
                requestAnimFrame: (function () {
                    return window.requestAnimationFrame || function (callback) { return window.setTimeout(callback, 1000 / 60); };
                })(),
                cancelAnimFrame: (function () {
                    return window.cancelAnimationFrame || function (id) { window.clearTimeout(id); };
                })(),
                distance: function (p1, p2) {
                    var dx = p2.x - p1.x,
                        dy = p2.y - p1.y;
                    return Math.sqrt(dx * dx + dy * dy);
                },
                getScale: function (map) {
                    var bounds = map.getBounds(),
                        center = bounds.getCenter(),
                        p1 = map.latLngToContainerPoint(center),
                        p2 = map.latLngToContainerPoint([center.lat, center.lng + 0.001]),
                        distanceMeters = 111.3 * Math.cos(center.lat * Math.PI / 180) * 1000;
                    return distanceMeters / p2.subtract(p1).x;
                }
            };

            Atlas.Class = function () {};
            Atlas.Class.extend = function (props) {
                var NewClass = function () {
                    if (this.initialize) { this.initialize.apply(this, arguments); }
                    this.callInitHooks();
                };
                var parentProto = NewClass.__super__ = this.prototype;
                var proto = Atlas.Util.create(parentProto);
                proto.constructor = NewClass;
                NewClass.prototype = proto;
                for (var i in this) {
                    if (this.hasOwnProperty(i) && i !== 'prototype' && i !== '__super__') {
                        NewClass[i] = this[i];
                    }
                }
                if (props.statics) { Atlas.Util.extend(NewClass, props.statics); delete props.statics; }
                if (props.includes) {
                    var includes = props.includes;
                    if (typeof includes.splice !== 'function') { includes = [includes]; }
                    for (var j = 0; j < includes.length; j++) { Atlas.Util.extend(proto, includes[j]); }
                    delete props.includes;
                }
                Atlas.Util.extend(proto, props);
                NewClass.addInitHook = function (fn) {
                    var args = Array.prototype.slice.call(arguments, 1);
                    var init = typeof fn === 'function' ? fn : function () { this[fn].apply(this, args); };
                    this.prototype._initHooks = this.prototype._initHooks || [];
                    this.prototype._initHooks.push(init);
                    return this;
                };
                proto._initHooks = [];
                proto.callInitHooks = function () {
                    if (this._initHooksCalled) return;
                    if (parentProto.callInitHooks) parentProto.callInitHooks.call(this);
                    this._initHooksCalled = true;
                    for (var i = 0, len = this._initHooks.length; i < len; i++) { this._initHooks[i].call(this); }
                };
                return NewClass;
            };

            Atlas.Events = {
                on: function (types, fn, context) {
                    if (typeof types === 'object') {
                        for (var type in types) this.on(type, types[type], fn);
                        return this;
                    }
                    types = Atlas.Util.splitWords(types);
                    for (var i = 0; i < types.length; i++) {
                        var t = types[i], events = this._events = this._events || {};
                        (events[t] = events[t] || []).push({ action: fn, context: context || this });
                    }
                    return this;
                },
                off: function (types, fn, context) {
                    if (!types) { this._events = {}; return this; }
                    types = Atlas.Util.splitWords(types);
                    for (var i = 0; i < types.length; i++) {
                        var t = types[i], listeners = this._events && this._events[t];
                        if (!listeners) continue;
                        for (var j = 0; j < listeners.length; j++) {
                            if (listeners[j].action === fn && (!context || listeners[j].context === context)) {
                                listeners.splice(j, 1); j--;
                            }
                        }
                    }
                    return this;
                },
                fire: function (type, data, propagate) {
                    if (!this.listens(type, propagate)) return this;
                    var event = Atlas.Util.extend({}, data, { type: type, target: this });
                    if (this._events && this._events[type]) {
                        var listeners = this._events[type].slice();
                        for (var i = 0; i < listeners.length; i++) { listeners[i].action.call(listeners[i].context, event); }
                    }
                    return this;
                },
                listens: function (type, propagate) {
                    var listeners = this._events && this._events[type];
                    return (listeners && listeners.length > 0);
                }
            };

            Atlas.Browser = (function () {
                var ua = navigator.userAgent.toLowerCase(),
                    mobile = typeof window.orientation !== 'undefined' || ua.indexOf('mobile') !== -1,
                    ie = 'ActiveXObject' in window,
                    ielt9 = ie && !document.addEventListener,
                    webkit = ua.indexOf('webkit') !== -1,
                    gecko = ua.indexOf('gecko') !== -1 && !webkit && !window.opera && !ie,
                    android = ua.indexOf('android') !== -1,
                    android23 = android && ua.indexOf('android 2') !== -1 && ua.indexOf('android 3') === -1,
                    chrome = ua.indexOf('chrome') !== -1,
                    safari = !chrome && ua.indexOf('safari') !== -1,
                    win = navigator.platform.indexOf('Win') === 0,
                    retina = (window.devicePixelRatio || (window.screen.deviceXDPI / window.screen.logicalXDPI)) > 1;
                return {
                    ie: ie,
                    ielt9: ielt9,
                    webkit: webkit,
                    gecko: gecko,
                    android: android,
                    android23: android23,
                    chrome: chrome,
                    safari: safari,
                    win: win,
                    mobile: mobile,
                    mobileWebkit: mobile && webkit,
                    mobileWebkit3d: mobile && webkit && 'WebKitCSSMatrix' in window && 'm11' in new window.WebKitCSSMatrix() && !android23,
                    touch: !!(('ontouchstart' in window) || window.DocumentTouch && document instanceof window.DocumentTouch),
                    msPointer: !window.PointerEvent && window.MSPointerEvent,
                    pointer: !!(window.PointerEvent || window.MSPointerEvent),
                    retina: retina
                };
            }());

            Atlas.DomUtil = {
                get: function (id) { return (typeof id === 'string' ? document.getElementById(id) : id); },
                getStyle: function (el, style) {
                    var value = el.style[style] || (el.currentStyle && el.currentStyle[style]);
                    if ((!value || value === 'auto') && document.defaultView) {
                        var css = document.defaultView.getComputedStyle(el, null);
                        value = css ? css[style] : null;
                    }
                    return value === 'auto' ? null : value;
                },
                create: function (tagName, className, container) {
                    var el = document.createElement(tagName);
                    el.className = className || '';
                    if (container) container.appendChild(el);
                    return el;
                },
                remove: function (el) {
                    var parent = el.parentNode;
                    if (parent) parent.removeChild(el);
                },
                empty: function (el) {
                    while (el.firstChild) {
                        el.removeChild(el.firstChild);
                    }
                },
                toFront: function (el) {
                    el.parentNode.appendChild(el);
                },
                toBack: function (el) {
                    var parent = el.parentNode;
                    parent.insertBefore(el, parent.firstChild);
                },
                addClass: function (el, name) {
                    if (el.classList !== undefined) {
                        var classes = Atlas.Util.splitWords(name);
                        for (var i = 0; i < classes.length; i++) el.classList.add(classes[i]);
                    } else { el.className += (el.className ? ' ' : '') + name; }
                },
                removeClass: function (el, name) {
                    if (el.classList !== undefined) { el.classList.remove(name); } 
                    else { el.className = Atlas.Util.trim((' ' + el.className + ' ').replace(' ' + name + ' ', ' ')); }
                },
                hasClass: function (el, name) {
                    return (el.className.length > 0) && new RegExp('(^|\\s)' + name + '(\\s|$)').test(el.className);
                },
                setOpacity: function (el, value) { 
                    if ('opacity' in el.style) {
                        el.style.opacity = value;
                    } else if ('filter' in el.style) {
                        el.style.filter = 'alpha(opacity=' + (value * 100) + ')';
                    }
                },
                testProp: function (props) {
                    var style = document.documentElement.style;
                    for (var i = 0; i < props.length; i++) { if (props[i] in style) return props[i]; }
                    return false;
                },
                setTransform: function (el, offset, scale) {
                    var pos = offset || new Atlas.Point(0, 0);
                    el.style[Atlas.DomUtil.TRANSFORM] = 
                        (Atlas.Browser.ie3d ? 
                            'translate(' + pos.x + 'px,' + pos.y + 'px)' : 
                            'translate3d(' + pos.x + 'px,' + pos.y + 'px,0)') + 
                        (scale ? ' scale(' + scale + ')' : '');
                },
                setPosition: function (el, point) {
                    el._atlas_pos = point;
                    Atlas.DomUtil.setTransform(el, point);
                },
                getPosition: function (el) { return el._atlas_pos || new Atlas.Point(0, 0); }
            };
            Atlas.DomUtil.TRANSFORM = Atlas.DomUtil.testProp(['transform', 'WebkitTransform', 'OTransform', 'MozTransform', 'msTransform']);

            Atlas.DomEvent = {
                on: function (obj, types, fn, context) {
                    if (typeof types === 'object') {
                        for (var type in types) this.on(obj, type, types[type], fn);
                        return this;
                    }
                    types = Atlas.Util.splitWords(types);
                    for (var i = 0; i < types.length; i++) {
                        var type = types[i];
                        var id = type + Atlas.Util.stamp(fn) + (context ? '_' + Atlas.Util.stamp(context) : '');
                        if (obj['_atlas_' + id]) return this;
                        var handler = function (e) { return fn.call(context || obj, e || window.event); };
                        if (Atlas.Browser.pointer && type.indexOf('touch') === 0) {
                            this.addPointerListener(obj, type, handler, id);
                        } else if (Atlas.Browser.touch && (type === 'dblclick') && this.addDoubleTapListener) {
                            this.addDoubleTapListener(obj, handler, id);
                        } else {
                            if (type === 'wheel' || type === 'mousewheel' || type === 'DOMMouseScroll') {
                                type = Atlas.Browser.gecko ? 'DOMMouseScroll' : 'wheel';
                                obj.addEventListener(Atlas.Browser.gecko ? 'DOMMouseScroll' : 'wheel', handler, false);
                            } else if (!Atlas.Browser.touch || type !== 'dblclick') {
                                var options = (type === 'wheel' || type === 'mousewheel' || type === 'touchstart' || type === 'touchmove' || type === 'touchend') ? { passive: false } : false;
                                obj.addEventListener(type, handler, options);
                            }
                        }
                        obj['_atlas_' + id] = handler;
                    }
                    return this;
                },
                off: function (obj, types, fn, context) {
                    if (!types) { this._events = {}; return this; }
                    types = Atlas.Util.splitWords(types);
                    for (var i = 0; i < types.length; i++) {
                        var type = types[i];
                        var id = type + Atlas.Util.stamp(fn) + (context ? '_' + Atlas.Util.stamp(context) : '');
                        var handler = obj['_atlas_' + id];
                        if (!handler) continue;
                        if (Atlas.Browser.pointer && type.indexOf('touch') === 0) {
                            this.removePointerListener(obj, type, id);
                        } else if (Atlas.Browser.touch && (type === 'dblclick') && this.removeDoubleTapListener) {
                            this.removeDoubleTapListener(obj, id);
                        } else {
                            if (type === 'wheel' || type === 'mousewheel' || type === 'DOMMouseScroll') {
                                type = Atlas.Browser.gecko ? 'DOMMouseScroll' : 'wheel';
                                obj.removeEventListener(Atlas.Browser.gecko ? 'DOMMouseScroll' : 'wheel', handler, false);
                            } else if (!Atlas.Browser.touch || type !== 'dblclick') {
                                obj.removeEventListener(type, handler, false);
                            }
                        }
                        delete obj['_atlas_' + id];
                    }
                    return this;
                },

                addPointerListener: function (obj, type, handler, id) {
                    var handlerObj = function (e) {
                        var mouseEvent = {};
                        mouseEvent.type = type === 'touchstart' ? 'mousedown' :
                                         type === 'touchmove'  ? 'mousemove' :
                                         type === 'touchend'   ? 'mouseup' : e.type;
                        mouseEvent.target = e.target;
                        mouseEvent.clientX = e.clientX != null ? e.clientX : (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
                        mouseEvent.clientY = e.clientY != null ? e.clientY : (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
                        mouseEvent.preventDefault = function () { if (e.preventDefault) e.preventDefault(); };
                        mouseEvent.stopPropagation = function () { if (e.stopPropagation) e.stopPropagation(); };
                        handler(mouseEvent);
                    };
                    obj['_atlas_' + id] = handlerObj;
                    obj.addEventListener('pointerdown', handlerObj, false);
                    if (type === 'touchstart') {
                        obj.addEventListener('pointermove', handlerObj, false);
                        obj.addEventListener('pointerup', handlerObj, false);
                    }
                },

                removePointerListener: function (obj, type, id) {
                    var handler = obj['_atlas_' + id];
                    if (!handler) return;
                    obj.removeEventListener('pointerdown', handler, false);
                    if (type === 'touchstart') {
                        obj.removeEventListener('pointermove', handler, false);
                        obj.removeEventListener('pointerup', handler, false);
                    }
                    delete obj['_atlas_' + id];
                },

                stopPropagation: function (e) {
                    if (e.stopPropagation) e.stopPropagation(); else e.cancelBubble = true;
                    return this;
                },
                preventDefault: function (e) {
                    if (e.preventDefault) e.preventDefault(); else e.returnValue = false;
                    return this;
                },
                stop: function (e) {
                    return Atlas.DomEvent.preventDefault(e).stopPropagation(e);
                },
                getMousePosition: function (e, container) {
                    if (e.touches && e.touches.length > 0) {
                        var touch = e.touches[0];
                        return new Atlas.Point(touch.clientX, touch.clientY);
                    }
                    if (e.changedTouches && e.changedTouches.length > 0) {
                        var changedTouch = e.changedTouches[0];
                        return new Atlas.Point(changedTouch.clientX, changedTouch.clientY);
                    }
                    var rect = container.getBoundingClientRect();
                    var clientX = e.clientX !== undefined ? e.clientX : (e.pageX - window.pageXOffset);
                    var clientY = e.clientY !== undefined ? e.clientY : (e.pageY - window.pageYOffset);
                    return new Atlas.Point(
                        clientX - rect.left - container.clientLeft,
                        clientY - rect.top - container.clientTop
                    );
                },
                getWheelDelta: function (e) {
                    var delta = 0;
                    if (e.wheelDelta) {
                        delta = e.wheelDelta / 120;
                    } else if (e.detail) {
                        delta = -e.detail / 3;
                    } else if (e.deltaY) {
                        delta = -e.deltaY / 100;
                    }
                    return delta;
                },
                _touchstart: Atlas.Browser.msPointer ? 'MSPointerDown' : Atlas.Browser.pointer ? 'pointerdown' : 'touchstart',
                _touchend: Atlas.Browser.msPointer ? 'MSPointerUp' : Atlas.Browser.pointer ? 'pointerup' : 'touchend',
                _touchmove: Atlas.Browser.msPointer ? 'MSPointerMove' : Atlas.Browser.pointer ? 'pointermove' : 'touchmove'
            };

            if (Atlas.Browser.touch) {
                Atlas.DomEvent.on(document, 'touchstart', function () {});
            }

            Atlas.Point = function (x, y, round) {
                this.x = (round ? Math.round(x) : x);
                this.y = (round ? Math.round(y) : y);
            };
            Atlas.Point.prototype = {
                clone: function () { return new Atlas.Point(this.x, this.y); },
                add: function (point) { return new Atlas.Point(this.x + point.x, this.y + point.y); },
                subtract: function (point) { return new Atlas.Point(this.x - point.x, this.y - point.y); },
                divideBy: function (num) { return new Atlas.Point(this.x / num, this.y / num); },
                multiplyBy: function (num) { return new Atlas.Point(this.x * num, this.y * num); },
                scaleBy: function (point) { return new Atlas.Point(this.x * point.x, this.y * point.y); },
                unscaleBy: function (point) { return new Atlas.Point(this.x / point.x, this.y / point.y); },
                round: function () { return new Atlas.Point(Math.round(this.x), Math.round(this.y)); },
                floor: function () { return new Atlas.Point(Math.floor(this.x), Math.floor(this.y)); },
                ceil: function () { return new Atlas.Point(Math.ceil(this.x), Math.ceil(this.y)); },
                distanceTo: function (point) { var x = point.x - this.x, y = point.y - this.y; return Math.sqrt(x * x + y * y); },
                equals: function (point) { return point.x === this.x && point.y === this.y; },
                contains: function (point) { return Math.abs(point.x) <= Math.abs(this.x) && Math.abs(point.y) <= Math.abs(this.y); }
            };

            Atlas.Bounds = function (a, b) {
                if (!a) return;
                var points = b ? [a, b] : a;
                for (var i = 0, len = points.length; i < len; i++) { this.extend(points[i]); }
            };
            Atlas.Bounds.prototype = {
                extend: function (point) {
                    if (!this.min && !this.max) { this.min = point.clone(); this.max = point.clone(); } 
                    else {
                        this.min.x = Math.min(point.x, this.min.x); this.max.x = Math.max(point.x, this.max.x);
                        this.min.y = Math.min(point.y, this.min.y); this.max.y = Math.max(point.y, this.max.y);
                    }
                    return this;
                },
                getCenter: function (round) { return new Atlas.Point((this.min.x + this.max.x) / 2, (this.min.y + this.max.y) / 2, round); },
                getSize: function () { return this.max.subtract(this.min); },
                contains: function (obj) {
                    var min, max;
                    if (obj instanceof Atlas.Bounds) { min = obj.min; max = obj.max; } else { min = max = obj; }
                    return (min.x >= this.min.x) && (max.x <= this.max.x) && (min.y >= this.min.y) && (max.y <= this.max.y);
                },
                intersects: function (bounds) {
                    var min = this.min,
                        max = this.max,
                        bmin = bounds.min,
                        bmax = bounds.max;
                    return max.x >= bmin.x && min.x <= bmax.x &&
                           max.y >= bmin.y && min.y <= bmax.y;
                },
                isValid: function () { return !!(this.min && this.max); }
            };

            Atlas.LatLng = function (lat, lng, alt) {
                if (isNaN(lat) || isNaN(lng)) throw new Error('Invalid LatLng object: (' + lat + ', ' + lng + ')');
                this.lat = +lat; this.lng = +lng;
                if (alt !== undefined) {
                    this.alt = +alt;
                }
            };

            Atlas.latLng = function (a, b, c) {
                if (a instanceof Atlas.LatLng) {
                    return a;
                }
                if (Atlas.Util.isArray(a) && a.length === 3) {
                    return new Atlas.LatLng(a[0], a[1], a[2]);
                }
                if (Atlas.Util.isArray(a) && a.length === 2) {
                    return new Atlas.LatLng(a[0], a[1]);
                }
                if (a === undefined || a === null) {
                    return a;
                }
                if (typeof a === 'object' && 'lat' in a) {
                    return new Atlas.LatLng(a.lat, 'lng' in a ? a.lng : a.lon, a.alt);
                }
                if (b === undefined) {
                    return null;
                }
                return new Atlas.LatLng(a, b, c);
            };

            Atlas.LatLng.prototype = {
                clone: function () { return new Atlas.LatLng(this.lat, this.lng, this.alt); },
                distanceTo: function (other) {
                    var R = 6378137;
                    var dLat = (other.lat - this.lat) * Math.PI / 180;
                    var dLon = (other.lng - this.lng) * Math.PI / 180;
                    var lat1 = this.lat * Math.PI / 180;
                    var lat2 = other.lat * Math.PI / 180;
                    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                            Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2); 
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
                    return R * c;
                },
                wrap: function () {
                    return new Atlas.LatLng(
                        this.lat,
                        Atlas.Util.wrapNum(this.lng, [-180, 180], true)
                    );
                },
                equals: function (obj, maxMargin) {
                    if (!obj) { return false; }
                    maxMargin = maxMargin === undefined ? 1.0E-9 : maxMargin;
                    return Math.abs(this.lat - obj.lat) <= maxMargin &&
                           Math.abs(this.lng - obj.lng) <= maxMargin;
                }
            };

            Atlas.LatLngBounds = function (southWest, northEast) {
                if (!southWest) { return; }
                var latlngs = northEast ? [southWest, northEast] : southWest;
                for (var i = 0, len = latlngs.length; i < len; i++) {
                    this.extend(latlngs[i]);
                }
            };

            Atlas.latLngBounds = function (a, b) {
                if (!a || a instanceof Atlas.LatLngBounds) {
                    return a;
                }
                return new Atlas.LatLngBounds(a, b);
            };

            Atlas.LatLngBounds.prototype = {
                extend: function (latLng) {
                    var lat, lng;
                    if (!latLng) { return this; }
                    if (!(latLng instanceof Atlas.LatLng)) {
                        if (Atlas.Util.isArray(latLng) && !isNaN(latLng[0]) && !isNaN(latLng[1])) {
                            latLng = new Atlas.LatLng(latLng[0], latLng[1]);
                        } else {
                            latLng = Atlas.latLng(latLng);
                        }
                    }
                    if (latLng instanceof Atlas.LatLng) {
                        lat = latLng.lat;
                        lng = latLng.lng;
                    } else if (latLng instanceof Atlas.LatLngBounds) {
                        this.extend(latLng.getSouthWest());
                        this.extend(latLng.getNorthEast());
                        return this;
                    } else {
                        throw new Error('Invalid LatLngBounds extend parameter');
                    }
                    if (!this.isValid()) {
                        this._southWest = new Atlas.LatLng(lat, lng);
                        this._northEast = new Atlas.LatLng(lat, lng);
                    } else {
                        this._southWest.lat = Math.min(lat, this._southWest.lat);
                        this._southWest.lng = Math.min(lng, this._southWest.lng);
                        this._northEast.lat = Math.max(lat, this._northEast.lat);
                        this._northEast.lng = Math.max(lng, this._northEast.lng);
                    }
                    return this;
                },
                pad: function (bufferRatio) {
                    var sw = this._southWest,
                        ne = this._northEast,
                        heightBuffer = Math.abs(sw.lat - ne.lat) * bufferRatio,
                        widthBuffer = Math.abs(sw.lng - ne.lng) * bufferRatio;
                    return new Atlas.LatLngBounds(
                        new Atlas.LatLng(sw.lat - heightBuffer, sw.lng - widthBuffer),
                        new Atlas.LatLng(ne.lat + heightBuffer, ne.lng + widthBuffer)
                    );
                },
                getCenter: function () {
                    return new Atlas.LatLng(
                        (this._southWest.lat + this._northEast.lat) / 2,
                        (this._southWest.lng + this._northEast.lng) / 2
                    );
                },
                getSouthWest: function () {
                    return this._southWest;
                },
                getNorthEast: function () {
                    return this._northEast;
                },
                getNorthWest: function () {
                    return new Atlas.LatLng(this._northEast.lat, this._southWest.lng);
                },
                getSouthEast: function () {
                    return new Atlas.LatLng(this._southWest.lat, this._northEast.lng);
                },
                getWest: function () {
                    return this._southWest.lng;
                },
                getSouth: function () {
                    return this._southWest.lat;
                },
                getEast: function () {
                    return this._northEast.lng;
                },
                getNorth: function () {
                    return this._northEast.lat;
                },
                contains: function (obj) {
                    var sw = this._southWest,
                        ne = this._northEast,
                        sw2, ne2;
                    if (obj instanceof Atlas.LatLng) {
                        return sw.lat <= obj.lat && obj.lat <= ne.lat &&
                               sw.lng <= obj.lng && obj.lng <= ne.lng;
                    } else if (obj instanceof Atlas.LatLngBounds) {
                        sw2 = obj.getSouthWest();
                        ne2 = obj.getNorthEast();
                        return sw.lat <= sw2.lat && ne2.lat <= ne.lat &&
                               sw.lng <= sw2.lng && ne2.lng <= ne.lng;
                    }
                    return false;
                },
                intersects: function (bounds) {
                    var sw = this._southWest,
                        ne = this._northEast,
                        sw2 = bounds.getSouthWest(),
                        ne2 = bounds.getNorthEast();
                    var latIntersects = (sw2.lat <= ne.lat) && (sw.lat <= ne2.lat),
                        lngIntersects = (sw2.lng <= ne.lng) && (sw.lng <= ne2.lng);
                    return latIntersects && lngIntersects;
                },
                toBBoxString: function () {
                    return [this.getWest(), this.getSouth(), this.getEast(), this.getNorth()].join(',');
                },
                equals: function (bounds) {
                    if (!bounds) { return false; }
                    return this._southWest.equals(bounds.getSouthWest()) &&
                           this._northEast.equals(bounds.getNorthEast());
                },
                isValid: function () {
                    return !!(this._southWest && this._northEast);
                }
            };

            Atlas.Projection = {};
            Atlas.Projection.SphericalMercator = {
                R: 6378137, MAX_LATITUDE: 85.0511287798,
                project: function (latlng) {
                    var d = Math.PI / 180, max = this.MAX_LATITUDE, lat = Math.max(Math.min(max, latlng.lat), -max), sin = Math.sin(lat * d);
                    return new Atlas.Point(this.R * latlng.lng * d, this.R * Math.log((1 + sin) / (1 - sin)) / 2);
                },
                unproject: function (point) {
                    var d = 180 / Math.PI;
                    return new Atlas.LatLng((2 * Math.atan(Math.exp(point.y / this.R)) - (Math.PI / 2)) * d, point.x * d / this.R);
                }
            };

            Atlas.CRS = {
                Earth: {
                    R: 6378137
                },
                scale: function (zoom) { return 256 * Math.pow(2, zoom); },
                latLngToPoint: function (latlng, zoom) {
                    var projectedPoint = Atlas.Projection.SphericalMercator.project(latlng), scale = this.scale(zoom);
                    return this.transformation._transform(projectedPoint, scale);
                },
                pointToLatLng: function (point, zoom) {
                    var scale = this.scale(zoom), untransformedPoint = this.transformation.untransform(point, scale);
                    return Atlas.Projection.SphericalMercator.unproject(untransformedPoint);
                },
                transformation: (function() {
                    var scale = 0.5 / (Math.PI * Atlas.Projection.SphericalMercator.R);
                    return {
                        _transform: function(point, k) { point.x = k * (scale * point.x + 0.5); point.y = k * (-scale * point.y + 0.5); return point; },
                        untransform: function(point, k) { return new Atlas.Point((point.x / k - 0.5) / scale, (point.y / k - 0.5) / -scale); }
                    };
                })()
            };

            Atlas.Map = Atlas.Class.extend({
                includes: Atlas.Events,
                options: { 
                    crs: Atlas.CRS,
                    center: [0, 0],
                    zoom: 0,
                    minZoom: 0, 
                    maxZoom: 18, 
                    layers: [],
                    dragging: true, 
                    zoomControl: true, 
                    attributionControl: true,
                    scaleControl: false,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    zoomAnimation: true, 
                    fadeAnimation: true, 
                    inertia: true,
                    inertiaDeceleration: 3000,
                    inertiaMaxSpeed: 1500,
                    easeLinearity: 0.25,
                    worldCopyJump: false,
                    maxBoundsViscosity: 0.0,
                    keyboard: true,
                    keyboardPanDelta: 80,
                    closePopupOnClick: true,
                    bounceAtZoomLimits: true
                },
                initialize: function (id, options) {
                    options = Atlas.Util.setOptions(this, options);
                    this._container = Atlas.DomUtil.get(id);
                    if (!this._container) throw new Error('Map container not found.');
                    this._container._atlas_map = this;
                    this._initLayout();
                    this._initEvents();
                    if (Atlas.DomUtil.TRANSFORM) {
                        Atlas.DomUtil.addClass(this._container, 'atlas-zoom-' + (this.options.zoomAnimation ? 'animated' : 'hide'));
                    }
                    this._layers = {};
                    this._zoomBoundLayers = {};
                    this._sizeChanged = true;
                    this._handlers = [];
                    this._addLoader();
                    this.whenReady(this._initLayers, this);
                    if (options.maxBounds) {
                        this.setMaxBounds(options.maxBounds);
                    }
                    if (options.zoomControl) {
                        this.addControl(new Atlas.Control.Zoom());
                    }
                    if (options.attributionControl) {
                        this.attributionControl = new Atlas.Control.Attribution();
                        this.addControl(this.attributionControl);
                    }
                    if (options.scaleControl) {
                        this.addControl(new Atlas.Control.Scale());
                    }
                    if (Atlas.Handler.MapDrag) {
                        this.addHandler('dragging', Atlas.Handler.MapDrag);
                    }
                    if (Atlas.Handler.ScrollWheelZoom) {
                        this.addHandler('scrollWheelZoom', Atlas.Handler.ScrollWheelZoom);
                    }
                    if (Atlas.Handler.DoubleClickZoom) {
                        this.addHandler('doubleClickZoom', Atlas.Handler.DoubleClickZoom);
                    }
                    if (Atlas.Handler.TouchZoom) {
                        this.addHandler('touchZoom', Atlas.Handler.TouchZoom);
                    }
                    if (Atlas.Handler.BoxZoom) {
                        this.addHandler('boxZoom', Atlas.Handler.BoxZoom);
                    }
                    if (Atlas.Handler.Keyboard) {
                        this.addHandler('keyboard', Atlas.Handler.Keyboard);
                    }
                    this.whenReady(this._checkIfLoaded, this);
                },
                setView: function (center, zoom, options) {
                    zoom = zoom === undefined ? this._zoom : this._limitZoom(zoom);
                    center = Atlas.latLng(center);
                    this._stop();
                    if (this._loaded && !options.reset && options !== true) {
                        if (options.animate !== undefined) {
                            options.zoom = Atlas.Util.extend({animate: options.animate}, options.zoom);
                            options.pan = Atlas.Util.extend({animate: options.animate}, options.pan);
                        }
                        var moved = this._zoom !== zoom || !center.equals(this._center);
                        this._zoom = zoom;
                        this._lastCenter = null;
                        this._pixelOrigin = this._getNewPixelOrigin(center, zoom);
                        if (!options.zoom && !options.pan) {
                            this.fire('move');
                            if (moved) {
                                this.fire('zoomend');
                            }
                        }
                        if (options.zoom) {
                            if (options.zoom.animate !== undefined) {
                                this.options.zoomAnimation = options.zoom.animate;
                            }
                            this._animateZoom(center, zoom, true, options.pan);
                        } else {
                            this._resetView(center, zoom);
                        }
                        return this;
                    }
                    this._resetView(center, zoom);
                    return this;
                },
                setZoom: function (zoom, options) { 
                    if (!this._loaded) {
                        this._zoom = this._limitZoom(zoom);
                        return this;
                    }
                    return this.setView(this.getCenter(), zoom, {zoom: options});
                },
                zoomIn: function (delta, options) { 
                    return this.setZoom(this._zoom + (delta || 1), options);
                },
                zoomOut: function (delta, options) { 
                    return this.setZoom(this._zoom - (delta || 1), options);
                },
                setZoomAround: function (latlng, zoom, options) {
                    var scale = this.getZoomScale(zoom),
                        viewHalf = this.getSize()._divideBy(2),
                        containerPoint = latlng instanceof Atlas.Point ? latlng : this.latLngToContainerPoint(latlng),
                        centerOffset = containerPoint.subtract(viewHalf)._multiplyBy(1 - 1 / scale),
                        newCenter = this.containerPointToLatLng(viewHalf.add(centerOffset));
                    return this.setView(newCenter, zoom, {zoom: options});
                },
                fitBounds: function (bounds, options) {
                    bounds = bounds.getBounds ? bounds.getBounds() : Atlas.latLngBounds(bounds);
                    if (!bounds.isValid()) {
                        throw new Error('Bounds are not valid.');
                    }
                    options = options || {};
                    var paddingTL = Atlas.point(options.paddingTopLeft || options.padding || [0, 0]),
                        paddingBR = Atlas.point(options.paddingBottomRight || options.padding || [0, 0]),
                        zoom = this.getBoundsZoom(bounds, options.maxZoom, paddingTL.add(paddingBR));
                    zoom = (typeof options.maxZoom === 'number') ? Math.min(options.maxZoom, zoom) : zoom;
                    var paddingOffset = paddingBR.subtract(paddingTL).divideBy(2),
                        swPoint = this.project(bounds.getSouthWest(), zoom),
                        nePoint = this.project(bounds.getNorthEast(), zoom),
                        center = this.unproject(swPoint.add(nePoint).divideBy(2).add(paddingOffset), zoom);
                    return this.setView(center, zoom, options);
                },
                fitWorld: function (options) {
                    return this.fitBounds([[-90, -180], [90, 180]], options);
                },
                panTo: function (latlng, options) {
                    return this.setView(latlng, this._zoom, {pan: options});
                },
                panBy: function (offset, options) {
                    offset = Atlas.point(offset).round();
                    options = options || {};
                    if (!offset.x && !offset.y) {
                        return this.fire('moveend');
                    }
                    if (!this._panAnim) {
                        this._panAnim = new Atlas.PosAnimation();
                        this._panAnim.on({
                            'step': this._onPanTransitionStep,
                            'end': this._onPanTransitionEnd
                        }, this);
                    }
                    Atlas.DomUtil.addClass(this._mapPane, 'atlas-pan-anim');
                    var newPos = this._getMapPanePos().subtract(offset)._round();
                    if (!options.noMoveStart) {
                        this.fire('movestart');
                    }
                    this._panAnim.run(this._mapPane, newPos, options.duration || 0.25, options.easeLinearity);
                    return this;
                },
                setMaxBounds: function (bounds) {
                    bounds = Atlas.latLngBounds(bounds);
                    if (!bounds) {
                        return this.off('moveend', this._panInsideMaxBounds);
                    }
                    if (!this._loaded) {
                        return this.whenReady(function () {
                            this.setMaxBounds(bounds);
                        }, this);
                    }
                    if (this.options.maxBounds) {
                        this.off('moveend', this._panInsideMaxBounds);
                    }
                    this.options.maxBounds = bounds;
                    if (this._loaded) {
                        this._panInsideMaxBounds();
                    }
                    return this.on('moveend', this._panInsideMaxBounds, this);
                },
                getBounds: function () {
                    var bounds = this.getPixelBounds(),
                        sw = this.unproject(bounds.min),
                        ne = this.unproject(bounds.max);
                    return new Atlas.LatLngBounds(sw, ne);
                },
                getMinZoom: function () {
                    return this.options.minZoom === undefined ? this._layersMinZoom || 0 : this.options.minZoom;
                },
                getMaxZoom: function () {
                    return this.options.maxZoom === undefined ? (this._layersMaxZoom === undefined ? Infinity : this._layersMaxZoom) : this.options.maxZoom;
                },
                getBoundsZoom: function (bounds, inside, padding) {
                    bounds = Atlas.latLngBounds(bounds);
                    padding = Atlas.point(padding || [0, 0]);
                    var zoom = this.getMaxZoom() + 1,
                        min = this.project(bounds.getNorthWest(), zoom).add(padding),
                        max = this.project(bounds.getSouthEast(), zoom).subtract(padding),
                        size = this.getSize().subtract(padding.multiplyBy(2)),
                        boundsSize = max.subtract(min),
                        snap = Atlas.Browser.any3d ? this.options.zoomSnap : 1,
                        newZoom;
                    if (!inside) {
                        zoom--;
                    }
                    do {
                        zoom--;
                        newZoom = snap ? Math.round(zoom / snap) * snap : zoom;
                        min = this.project(bounds.getNorthWest(), newZoom);
                        max = this.project(bounds.getSouthEast(), newZoom);
                        boundsSize = max.subtract(min);
                    } while ((inside ? boundsSize.x < size.x || boundsSize.y < size.y : boundsSize.x > size.x || boundsSize.y > size.y) && zoom > this.getMinZoom());
                    return newZoom;
                },
                getSize: function () {
                    if (!this._size || this._sizeChanged) {
                        this._size = new Atlas.Point(
                            this._container.clientWidth,
                            this._container.clientHeight
                        );
                        this._sizeChanged = false;
                    }
                    return this._size;
                },
                getPixelBounds: function (center, zoom) {
                    var topLeftPoint = this._getTopLeftPoint(center, zoom);
                    return new Atlas.Bounds(topLeftPoint, topLeftPoint.add(this.getSize()));
                },
                getPixelOrigin: function () {
                    return this._pixelOrigin;
                },
                getPixelWorldBounds: function (zoom) {
                    return this.options.crs.getProjectedBounds(zoom === undefined ? this._zoom : zoom);
                },
                getZoom: function () {
                    return this._zoom;
                },
                getCenter: function () {
                    this._checkIfLoaded();
                    if (this._lastCenter && !this._moved()) {
                        return this._lastCenter;
                    }
                    return this.layerPointToLatLng(this._getCenterLayerPoint());
                },
                getZoomScale: function (toZoom, fromZoom) {
                    var crs = this.options.crs;
                    fromZoom = fromZoom === undefined ? this._zoom : fromZoom;
                    return crs.scale(toZoom) / crs.scale(fromZoom);
                },
                getScaleZoom: function (scale, fromZoom) {
                    var crs = this.options.crs;
                    fromZoom = fromZoom === undefined ? this._zoom : fromZoom;
                    var zoom = crs.zoom(scale * crs.scale(fromZoom));
                    return isNaN(zoom) ? Infinity : zoom;
                },
                project: function (latlng, zoom) {
                    zoom = zoom === undefined ? this._zoom : zoom;
                    return this.options.crs.latLngToPoint(Atlas.latLng(latlng), zoom);
                },
                unproject: function (point, zoom) {
                    zoom = zoom === undefined ? this._zoom : zoom;
                    return this.options.crs.pointToLatLng(Atlas.point(point), zoom);
                },
                layerPointToLatLng: function (point) {
                    var projectedPoint = Atlas.point(point).add(this.getPixelOrigin());
                    return this.unproject(projectedPoint);
                },
                latLngToLayerPoint: function (latlng) {
                    var projectedPoint = this.project(Atlas.latLng(latlng));
                    return projectedPoint._subtract(this.getPixelOrigin());
                },
                wrapLatLng: function (latlng) {
                    return this.options.crs.wrapLatLng ? this.options.crs.wrapLatLng(Atlas.latLng(latlng)) : Atlas.latLng(latlng);
                },
                wrapLatLngBounds: function (bounds) {
                    return this.options.crs.wrapLatLngBounds ? this.options.crs.wrapLatLngBounds(Atlas.latLngBounds(bounds)) : Atlas.latLngBounds(bounds);
                },
                distance: function (latlng1, latlng2) {
                    return this.options.crs.distance(latlng1, latlng2);
                },
                containerPointToLayerPoint: function (point) {
                    return Atlas.point(point).subtract(this._getMapPanePos());
                },
                layerPointToContainerPoint: function (point) {
                    return Atlas.point(point).add(this._getMapPanePos());
                },
                containerPointToLatLng: function (point) {
                    var layerPoint = this.containerPointToLayerPoint(Atlas.point(point));
                    return this.layerPointToLatLng(layerPoint);
                },
                latLngToContainerPoint: function (latlng) {
                    return this.layerPointToContainerPoint(this.latLngToLayerPoint(Atlas.latLng(latlng)));
                },
                mouseEventToContainerPoint: function (e) {
                    return Atlas.DomEvent.getMousePosition(e, this._container);
                },
                mouseEventToLayerPoint: function (e) {
                    return this.containerPointToLayerPoint(this.mouseEventToContainerPoint(e));
                },
                mouseEventToLatLng: function (e) {
                    return this.layerPointToLatLng(this.mouseEventToLayerPoint(e));
                },
                addLayer: function (layer) {
                    if (!layer) { return this; }
                    var id = Atlas.Util.stamp(layer);
                    if (this._layers[id]) { return this; }
                    this._layers[id] = layer;
                    layer._mapToAdd = this;
                    if (layer.beforeAdd) {
                        layer.beforeAdd(this);
                    }
                    this.whenReady(layer._layerAdd, layer);
                    return this;
                },
                removeLayer: function (layer) {
                    var id = Atlas.Util.stamp(layer);
                    if (!this._layers[id]) { return this; }
                    if (this._loaded) {
                        layer.onRemove(this);
                    }
                    if (layer.getAttribution && this.attributionControl) {
                        this.attributionControl.removeAttribution(layer.getAttribution());
                    }
                    delete this._layers[id];
                    if (this._loaded) {
                        this.fire('layerremove', {layer: layer});
                    }
                    return this;
                },
                hasLayer: function (layer) {
                    if (!layer) { return false; }
                    return Atlas.Util.stamp(layer) in this._layers;
                },
                eachLayer: function (method, context) {
                    for (var i in this._layers) {
                        if (this._layers.hasOwnProperty(i)) {
                            method.call(context, this._layers[i]);
                        }
                    }
                    return this;
                },
                _addLayers: function (layers) {
                    layers = layers ? (Atlas.Util.isArray(layers) ? layers : [layers]) : [];
                    for (var i = 0, len = layers.length; i < len; i++) {
                        this.addLayer(layers[i]);
                    }
                },
                _initLayers: function (options) {
                    options = Atlas.Util.extend({}, this.options.layers);
                    if (options.layers) {
                        this._addLayers(options.layers);
                        delete options.layers;
                    }
                    Atlas.Util.setOptions(this, options);
                    if (options.center && options.zoom !== undefined) {
                        this.setView(Atlas.latLng(options.center), options.zoom, {reset: true});
                    }
                    this._loaded = true;
                    this.fire('load');
                    this._update();
                    if (!this._loaded && !this._frames) {
                        this._frames = 1;
                    }
                    this._move();
                },
                _addLoader: function () {
                    if (!this._loader) {
                        this._loader = Atlas.DomUtil.create('div', 'atlas-loader', this._container);
                    }
                },
                _removeLoader: function () {
                    if (this._loader) {
                        Atlas.DomUtil.remove(this._loader);
                        delete this._loader;
                    }
                },
                whenReady: function (callback, context) {
                    if (this._loaded) {
                        callback.call(context || this, {target: this});
                    } else {
                        this.on('load', callback, context);
                    }
                    return this;
                },
                _initLayout: function () {
                    var container = this._container;
                    Atlas.DomUtil.addClass(container, 'atlas-container ' + (Atlas.Browser.touch ? 'atlas-touch' : ''));
                    Atlas.DomUtil.addClass(container, 'atlas-retina');
                    if (Atlas.Browser.safari) {
                        Atlas.DomUtil.addClass(container, 'atlas-safari');
                    }
                    if (Atlas.Browser.webkit) {
                        Atlas.DomUtil.addClass(container, 'atlas-webkit');
                    }
                    if (Atlas.DomUtil.getStyle(container, 'position') !== 'absolute' && Atlas.DomUtil.getStyle(container, 'position') !== 'relative') {
                        container.style.position = 'relative';
                    }
                    this._initPanes();
                    if (this._initControlPos) {
                        this._initControlPos();
                    }
                },
                _initPanes: function () {
                    var panes = this._panes = {};
                    this._paneRenderers = {};
                    this._mapPane = this.createPane('atlas-map-pane', this._container);
                    Atlas.DomUtil.setPosition(this._mapPane, new Atlas.Point(0, 0));
                    this.createPane('atlas-tile-pane', this._mapPane);
                    this.createPane('atlas-shadow-pane');
                    this.createPane('atlas-overlay-pane');
                    this.createPane('atlas-marker-pane');
                    this.createPane('atlas-tooltip-pane');
                    this.createPane('atlas-popup-pane');
                    if (!this.options.markerZoomAnimation) {
                        Atlas.DomUtil.addClass(panes.markerPane, 'atlas-zoom-hide');
                        Atlas.DomUtil.addClass(panes.shadowPane, 'atlas-zoom-hide');
                    }
                },
                createPane: function (name, container) {
                    var className = 'atlas-pane' + (name ? ' ' + name : ''),
                        pane = Atlas.DomUtil.create('div', className, container || this._mapPane);
                    if (name === 'atlas-shadow-pane' || name === 'atlas-marker-pane' || name === 'atlas-tooltip-pane' || name === 'atlas-popup-pane') {
                        pane.style.zIndex = 400 + 200 * (this._panes[name] || 0);
                    }
                    this._panes[name] = pane;
                    return pane;
                },
                getPane: function (name) {
                    return typeof name === 'string' ? this._panes[name] : name;
                },
                getPanes: function () {
                    return this._panes;
                },
                _checkIfLoaded: function () {
                    if (!this._loaded) {
                        throw new Error('Map not initialized yet.');
                    }
                },
                _initEvents: function (onOff) {
                    if (!onOff) { onOff = 'on'; }
                    Atlas.DomEvent[onOff](this._container, 'click dblclick mousedown mouseup mouseover mouseout mousemove contextmenu keypress keydown keyup', this._handleDOMEvent, this);
                    if (this.options.trackResize) {
                        Atlas.DomEvent[onOff](window, 'resize', this._onResize, this);
                    }
                    Atlas.DomEvent[onOff](document, 'visibilitychange', this._onVisibilityChange, this);
                    if (Atlas.Browser.touch && !Atlas.Browser.pointer) {
                        Atlas.DomEvent[onOff](this._container, 'touchstart touchend touchmove', this._handleDOMEvent, this);
                        Atlas.DomEvent[onOff](document, 'touchend', this._handleDOMEvent, this);
                    }
                    if (this.options.closePopupOnClick) {
                        Atlas.DomEvent[onOff](this._container, 'click', this._closePopup, this);
                    }
                },
                _onResize: function () {
                    Atlas.Util.cancelAnimFrame(this._resizeRequest);
                    this._resizeRequest = Atlas.Util.requestAnimFrame(
                        function () { this.invalidateSize({debounceMoveend: true}); }, this);
                },
                _onVisibilityChange: function () {
                    if (document.visibilityState === 'hidden') {
                        this._stop();
                    }
                },
                _handleDOMEvent: function (e) {
                    Atlas.DomEvent.stopPropagation(e);
                    var type = e.type;
                    if (type === 'mousedown' || type === 'keypress' || type === 'keyup' || type === 'keydown') {
                        Atlas.DomEvent.preventDefault(e);
                    }
                    this._fireDOMEvent(e, type);
                },
                _closePopup: function (e) {
                    if (this._popup && this._popup.options.closeOnClick) {
                        this.closePopup();
                    }
                },
                _fireDOMEvent: function (e, type, target) {
                    if (e.type === 'click') {
                        var isMarker = target instanceof Atlas.Marker;
                        if (isMarker && !target.options.bubblingMouseEvents) {
                            Atlas.DomEvent.stopPropagation(e);
                        }
                    }
                    this.fire(type, {
                        originalEvent: e,
                        containerPoint: this.mouseEventToContainerPoint(e),
                        layerPoint: this.mouseEventToLayerPoint(e),
                        latlng: type === 'contextmenu' || type === 'click' ? this.mouseEventToLatLng(e) : undefined,
                        target: target || e.target
                    });
                },
                _resetView: function (center, zoom) {
                    Atlas.DomUtil.setPosition(this._mapPane, new Atlas.Point(0, 0));
                    var loading = !this._loaded;
                    this._loaded = true;
                    zoom = this._limitZoom(zoom);
                    this.fire('viewprereset');
                    var zoomChanged = this._zoom !== zoom;
                    this._zoom = zoom;
                    this._lastCenter = null;
                    var pixelOrigin = this._pixelOrigin = this._getNewPixelOrigin(center, zoom);
                    if (!this._moved()) {
                        this.fire('move');
                    }
                    if (!this._loaded || zoomChanged || loading) {
                        this.fire('zoomstart');
                    }
                    this.fire('moveend', {hard: !this._loaded});
                    if (zoomChanged || loading) {
                        this.fire('zoomend');
                    }
                    this.fire('viewreset');
                    this._updateSize();
                    this._updateLayers();
                    this._removeLoader();
                },
                _updateSize: function () {
                    this._sizeChanged = true;
                    var oldSize = this._size;
                    this._size = new Atlas.Point(
                        this._container.clientWidth,
                        this._container.clientHeight
                    );
                    if (oldSize && !oldSize.equals(this._size)) {
                        this.fire('resize', {
                            oldSize: oldSize,
                            newSize: this._size
                        });
                    }
                },
                _updateLayers: function () {
                    var zoom = this._zoom;
                    this._panes.tilePane.style.zIndex = 200;
                    this._panes.overlayPane.style.zIndex = 400;
                    this._panes.shadowPane.style.zIndex = 500;
                    this._panes.markerPane.style.zIndex = 600;
                    this._panes.tooltipPane.style.zIndex = 700;
                    this._panes.popupPane.style.zIndex = 800;
                    this._sortLayers();
                    var i, layer;
                    for (i in this._layers) {
                        if (this._layers.hasOwnProperty(i)) {
                            layer = this._layers[i];
                            if (!layer.options) { continue; }
                            var inRange = this._zoom in layer._zoomRange;
                            if (inRange) {
                                layer._update();
                            }
                            var moved = this._zoom !== layer._zoom;
                            layer._zoom = this._zoom;
                            if (moved && inRange) {
                                layer._moved = true;
                            }
                        }
                    }
                },
                _sortLayers: function () {
                    var layers = [],
                        i, layer;
                    for (i in this._layers) {
                        if (this._layers.hasOwnProperty(i)) {
                            layer = this._layers[i];
                            if (layer.getZIndex) {
                                layers.push({layer: layer, zIndex: layer.getZIndex()});
                            }
                        }
                    }
                    layers.sort(function (a, b) {
                        return a.zIndex - b.zIndex;
                    });
                    for (i = 0; i < layers.length; i++) {
                        layers[i].layer._setAutoZIndex(layers[i].zIndex);
                    }
                },
                _limitZoom: function (zoom) {
                    var min = this.getMinZoom(),
                        max = this.getMaxZoom(),
                        snap = Atlas.Browser.any3d ? this.options.zoomSnap : 1;
                    if (snap) {
                        zoom = Math.round(zoom / snap) * snap;
                    }
                    return Math.max(min, Math.min(max, zoom));
                },
                _onPanTransitionStep: function () {
                    this.fire('move');
                },
                _onPanTransitionEnd: function () {
                    Atlas.DomUtil.removeClass(this._mapPane, 'atlas-pan-anim');
                    this.fire('moveend');
                },
                _panInsideBounds: function (bounds, options) {
                    this._enforcingBounds = true;
                    var center = this.getCenter(),
                        newCenter = this._limitCenter(center, this._zoom, Atlas.latLngBounds(bounds));
                    if (!center.equals(newCenter)) {
                        this.panTo(newCenter, options);
                    }
                    this._enforcingBounds = false;
                    return this;
                },
                _panInsideMaxBounds: function () {
                    if (this._enforcingBounds || !this.options.maxBounds) { return; }
                    this.panInsideBounds(this.options.maxBounds);
                },
                _limitCenter: function (center, zoom, bounds) {
                    if (!bounds) { return center; }
                    var centerPoint = this.project(center, zoom),
                        viewHalf = this.getSize().divideBy(2),
                        viewBounds = new Atlas.Bounds(centerPoint.subtract(viewHalf), centerPoint.add(viewHalf)),
                        limitBounds = this.project(bounds.getNorthWest(), zoom).boundsTo(this.project(bounds.getSouthEast(), zoom)).pad(viewHalf.multiplyBy(this.options.maxBoundsViscosity));
                    if (viewBounds.intersects(limitBounds)) {
                        return center;
                    }
                    var offset = viewBounds.getClosestPointToOrigin(limitBounds);
                    return this.unproject(centerPoint.add(offset), zoom);
                },
                _getMapPanePos: function () {
                    return Atlas.DomUtil.getPosition(this._mapPane) || new Atlas.Point(0, 0);
                },
                _moved: function () {
                    var pos = this._getMapPanePos();
                    return pos && !pos.equals([0, 0]);
                },
                _getTopLeftPoint: function (center, zoom) {
                    var pixelOrigin = center && zoom !== undefined ?
                        this._getNewPixelOrigin(center, zoom) :
                        this.getPixelOrigin();
                    return pixelOrigin.subtract(this._getMapPanePos());
                },
                _getCenterLayerPoint: function () {
                    return this.containerPointToLayerPoint(this.getSize()._divideBy(2));
                },
                _getCenterOffset: function (latlng) {
                    return this.latLngToLayerPoint(latlng).subtract(this._getCenterLayerPoint());
                },
                _limitOffset: function (offset, bounds) {
                    if (!bounds) { return offset; }
                    var viewBounds = this.getPixelBounds(),
                        newBounds = new Atlas.Bounds(viewBounds.min.add(offset), viewBounds.max.add(offset));
                    return offset.add(this._getBoundsOffset(newBounds, bounds));
                },
                _getBoundsOffset: function (pixelBounds, maxBounds) {
                    var topLeft = Atlas.point(maxBounds.min),
                        size = Atlas.point(maxBounds.max).subtract(topLeft),
                        bounds = new Atlas.Bounds(topLeft, topLeft.add(size)),
                        centerOffset = pixelBounds.getCenter().subtract(bounds.getCenter()),
                        dx = 0,
                        dy = 0;
                    if (pixelBounds.max.x > bounds.max.x || (pixelBounds.min.x < bounds.min.x && centerOffset.x > 0)) {
                        dx = bounds.max.x - pixelBounds.max.x;
                    } else if (pixelBounds.min.x < bounds.min.x || (pixelBounds.max.x > bounds.max.x && centerOffset.x < 0)) {
                        dx = bounds.min.x - pixelBounds.min.x;
                    }
                    if (pixelBounds.max.y > bounds.max.y || (pixelBounds.min.y < bounds.min.y && centerOffset.y > 0)) {
                        dy = bounds.max.y - pixelBounds.max.y;
                    } else if (pixelBounds.min.y < bounds.min.y || (pixelBounds.max.y > bounds.max.y && centerOffset.y < 0)) {
                        dy = bounds.min.y - pixelBounds.min.y;
                    }
                    return new Atlas.Point(dx, dy);
                },
                _getNewPixelOrigin: function (center, zoom) {
                    var viewHalf = this.getSize()._divideBy(2);
                    return this.project(center, zoom)._subtract(viewHalf)._add(this._getMapPanePos())._round();
                },
                _stop: function () {
                    if (this._panAnim) {
                        this._panAnim.stop();
                    }
                    return this;
                },
                _rawPanBy: function (offset) {
                    Atlas.DomUtil.setPosition(this._mapPane, this._getMapPanePos().subtract(offset));
                },
                _onZoomTransitionEnd: function () {
                    this._animatingZoom = false;
                    Atlas.DomUtil.removeClass(this._mapPane, 'atlas-zoom-anim');
                    if (this._mapPane.style[Atlas.DomUtil.TRANSFORM]) {
                        this._mapPane.style[Atlas.DomUtil.TRANSFORM] = '';
                    }
                    this._move();
                    this._moveEnd(true);
                },
                _moveStart: function (zoomChanged) {
                    if (zoomChanged) {
                        this.fire('zoomstart');
                    }
                    this.fire('movestart');
                    return this;
                },
                _move: function (zoomChanged, moveStart) {
                    if (moveStart === undefined) {
                        moveStart = zoomChanged;
                    }
                    if (moveStart) {
                        this._moveStart(zoomChanged);
                    }
                    this._animatingZoom = false;
                    var bounds = this._getMapPanePos();
                    Atlas.DomUtil.setPosition(this._mapPane, bounds);
                    this.fire('move');
                    return this;
                },
                _moveEnd: function (zoomChanged) {
                    if (zoomChanged) {
                        this.fire('zoomend');
                    }
                    this.fire('moveend');
                    return this;
                },
                _animateZoom: function (center, zoom, startAnim, noUpdate) {
                    if (!this._mapPane) { return; }
                    if (startAnim) {
                        this._animatingZoom = true;
                        Atlas.DomUtil.addClass(this._mapPane, 'atlas-zoom-anim');
                    }
                    this.fire('zoomanim', {
                        center: center,
                        zoom: zoom,
                        noUpdate: noUpdate
                    });
                    setTimeout(Atlas.Util.bind(this._onZoomTransitionEnd, this), 250);
                },
                _update: function () {
                    if (this._animatingZoom) { return; }
                    this._updateSize();
                    this._updateLayers();
                },
                addControl: function (control) {
                    control.addTo(this);
                    return this;
                },
                removeControl: function (control) {
                    control.remove();
                    return this;
                },
                addHandler: function (name, HandlerClass) {
                    if (!HandlerClass) { return this; }
                    var handler = this[name] = new HandlerClass(this);
                    this._handlers.push(handler);
                    if (this.options[name]) {
                        handler.enable();
                    }
                    return this;
                },
                remove: function () {
                    this._initEvents('off');
                    try {
                        this._container.removeChild(this._mapPane);
                    } catch (e) {}
                    this._clearPanes();
                    if (this._resizeRequest) {
                        Atlas.Util.cancelAnimFrame(this._resizeRequest);
                        this._resizeRequest = null;
                    }
                    this._clearHandlers();
                    if (this._container._atlas_map) {
                        this._container._atlas_map = null;
                    }
                    return this;
                },
                _clearPanes: function () {
                    for (var pane in this._panes) {
                        if (this._panes.hasOwnProperty(pane)) {
                            Atlas.DomUtil.remove(this._panes[pane]);
                        }
                    }
                    this._panes = {};
                },
                _clearHandlers: function () {
                    for (var i = 0, len = this._handlers.length; i < len; i++) {
                        this._handlers[i].disable();
                    }
                },
                invalidateSize: function (options) {
                    if (!this._loaded) { return this; }
                    options = Atlas.Util.extend({
                        animate: false,
                        pan: true
                    }, options === true ? {animate: true} : options);
                    var oldSize = this.getSize();
                    this._sizeChanged = true;
                    this._lastCenter = null;
                    var newSize = this.getSize(),
                        oldCenter = this.getCenter();
                    if (!oldSize.equals(newSize)) {
                        this.fire('resize', {
                            oldSize: oldSize,
                            newSize: newSize
                        });
                        if (options.animate && options.pan) {
                            this.panBy(oldSize.subtract(newSize).divideBy(2), {
                                animate: true,
                                duration: 0.25
                            });
                        }
                    }
                    return this;
                }
            });

            Atlas.map = function (id, options) {
                return new Atlas.Map(id, options);
            };

            Atlas.point = function (x, y, round) {
                if (x instanceof Atlas.Point) {
                    return x;
                }
                if (Atlas.Util.isArray(x)) {
                    return new Atlas.Point(x[0], x[1]);
                }
                if (x === undefined || x === null) {
                    return x;
                }
                if (typeof x === 'object' && 'x' in x && 'y' in x) {
                    return new Atlas.Point(x.x, x.y);
                }
                return new Atlas.Point(x, y, round);
            };

            Atlas.bounds = function (a, b) {
                if (!a || a instanceof Atlas.Bounds) {
                    return a;
                }
                var points = b ? [a, b] : a;
                return new Atlas.Bounds(points);
            };

            Atlas.PosAnimation = Atlas.Class.extend({
                includes: Atlas.Events,
                run: function (el, newPos, duration, easeLinearity) {
                    this.stop();
                    this._el = el;
                    this._inProgress = true;
                    this._duration = duration || 0.25;
                    this._easeOutPower = 1 / Math.max(easeLinearity || 0.5, 0.2);
                    this._startPos = Atlas.DomUtil.getPosition(el);
                    this._offset = newPos.subtract(this._startPos);
                    this._startTime = +new Date();
                    this.fire('start');
                    this._animate();
                },
                stop: function () {
                    if (!this._inProgress) { return; }
                    this._step(true);
                    this._complete();
                },
                _animate: function () {
                    this._animId = Atlas.Util.requestAnimFrame(this._animate, this);
                    this._step();
                },
                _step: function (round) {
                    var elapsed = (+new Date()) - this._startTime,
                        duration = this._duration * 1000;
                    if (elapsed < duration) {
                        this._runFrame(this._easeOut(elapsed / duration), round);
                    } else {
                        this._runFrame(1);
                        this._complete();
                    }
                },
                _runFrame: function (progress, round) {
                    var pos = this._startPos.add(this._offset.multiplyBy(progress));
                    if (round) {
                        pos = pos.round();
                    }
                    Atlas.DomUtil.setPosition(this._el, pos);
                    this.fire('step');
                },
                _complete: function () {
                    Atlas.Util.cancelAnimFrame(this._animId);
                    this._inProgress = false;
                    this.fire('end');
                },
                _easeOut: function (t) {
                    return 1 - Math.pow(1 - t, this._easeOutPower);
                }
            });

            Atlas.GridLayer = Atlas.Class.extend({
                includes: Atlas.Events,
                options: { 
                    tileSize: 256, 
                    opacity: 1, 
                    updateWhenIdle: Atlas.Browser.mobile,
                    updateWhenZooming: true,
                    updateInterval: 200,
                    attribution: null,
                    zIndex: 1, 
                    bounds: null,
                    minZoom: 0, 
                    maxZoom: 18, 
                    noWrap: false,
                    pane: 'atlas-tile-pane',
                    className: '',
                    keepBuffer: 2 
                },
                initialize: function (options) { 
                    options = Atlas.Util.setOptions(this, options);
                },
                onAdd: function (map) {
                    this._map = map;
                    this._initContainer();
                    this._levels = {};
                    this._tileCoordsToKey = {};
                    this._resetView();
                    map.on('moveend', this._resetView, this);
                    if (this._zoomAnimated) {
                        map.on('zoomanim', this._animateZoom, this);
                    }
                    if (this.getAttribution) {
                        map.attributionControl.addAttribution(this.getAttribution());
                    }
                    this._update();
                },
                onRemove: function (map) {
                    this._removeAllTiles();
                    Atlas.DomUtil.remove(this._container);
                    map.off('moveend', this._resetView, this);
                    if (this._zoomAnimated) {
                        map.off('zoomanim', this._animateZoom, this);
                    }
                    if (this.getAttribution) {
                        map.attributionControl.removeAttribution(this.getAttribution());
                    }
                    this._map = null;
                },
                bringToFront: function () {
                    if (this._map) {
                        Atlas.DomUtil.toFront(this._container);
                        this._setAutoZIndex(Math.max);
                    }
                    return this;
                },
                bringToBack: function () {
                    if (this._map) {
                        Atlas.DomUtil.toBack(this._container);
                        this._setAutoZIndex(Math.min);
                    }
                    return this;
                },
                getContainer: function () {
                    return this._container;
                },
                setOpacity: function (opacity) {
                    this.options.opacity = opacity;
                    this._updateOpacity();
                    return this;
                },
                setZIndex: function (zIndex) {
                    this.options.zIndex = zIndex;
                    this._updateZIndex();
                    return this;
                },
                isLoading: function () {
                    return this._loading;
                },
                redraw: function () {
                    if (this._map) {
                        this._removeAllTiles();
                        this._update();
                    }
                    return this;
                },
                getEvents: function () {
                    var events = {
                        viewprereset: this._invalidateAll,
                        viewreset: this._resetView,
                        zoom: this._resetView,
                        moveend: this._onMoveEnd
                    };
                    if (!this._zoomAnimated) {
                        events.zoomanim = this._animateZoom;
                    }
                    return events;
                },
                createTile: function () {
                    return document.createElement('div');
                },
                getTileSize: function () {
                    return Atlas.point(this.options.tileSize);
                },
                _initContainer: function () {
                    if (this._container) { return; }
                    this._container = Atlas.DomUtil.create('div', 'atlas-layer ' + (this.options.className || ''));
                    this._updateZIndex();
                    if (this.options.opacity !== 1) {
                        this._updateOpacity();
                    }
                    var pane = this.getPane();
                    pane.appendChild(this._container);
                },
                getPane: function () {
                    return this._map.getPane(this.options.pane);
                },
                _updateZIndex: function () {
                    if (this._container && this.options.zIndex !== undefined && this.options.zIndex !== null) {
                        this._container.style.zIndex = this.options.zIndex;
                    }
                },
                _updateOpacity: function () {
                    if (!this._map) { return; }
                    if (Atlas.Browser.ielt9) {
                        return;
                    }
                    Atlas.DomUtil.setOpacity(this._container, this.options.opacity);
                },
                _setAutoZIndex: function (compare) {
                    var layers = this.getPane().children,
                        edgeZIndex = -compare(-Infinity, Infinity);
                    for (var i = 0, len = layers.length, zIndex; i < len; i++) {
                        var layer = layers[i];
                        if (layer !== this._container) {
                            zIndex = parseInt(layer.style.zIndex, 10);
                            if (!isNaN(zIndex)) {
                                edgeZIndex = compare(edgeZIndex, zIndex);
                            }
                        }
                    }
                    this.options.zIndex = this._container.style.zIndex =
                        (isFinite(edgeZIndex) ? edgeZIndex : 0) + compare(-1, 1);
                },
                _updateLevels: function () {
                    var zoom = this._tileZoom,
                        maxZoom = this.options.maxZoom;
                    for (var z in this._levels) {
                        if (this._levels[z].el.children.length || z === zoom) {
                            this._levels[z].el.style.zIndex = maxZoom - Math.abs(zoom - z);
                            this._onUpdateLevel(z);
                        } else {
                            Atlas.DomUtil.remove(this._levels[z].el);
                            this._removeTilesAtZoom(z);
                            delete this._levels[z];
                        }
                    }
                    var level = this._levels[zoom],
                        map = this._map;
                    if (!level) {
                        level = this._levels[zoom] = {};
                        level.el = Atlas.DomUtil.create('div', 'atlas-tile-container atlas-zoom-animated', this._container);
                        level.el.style.zIndex = maxZoom;
                        level.origin = map.project(map.unproject(map.getPixelOrigin()), zoom).round();
                        level.zoom = zoom;
                        this._setZoomTransform(level, map.unproject(map.getPixelOrigin()), map.getZoom());
                        var tileSize = this.getTileSize();
                        level.el.style.width = map.getSize().x + tileSize.x + 'px';
                        level.el.style.height = map.getSize().y + tileSize.y + 'px';
                    }
                    this._level = level;
                    return level;
                },
                _onUpdateLevel: function (zoom) {},
                _update: function (center) {
                    var map = this._map;
                    if (!map) { return; }
                    var zoom = Math.round(map.getZoom());
                    if (center === undefined) {
                        center = map.getCenter();
                    }
                    if (this._tileZoom === undefined) {
                        return;
                    }
                    var pixelBounds = this._getTilePixelBounds(center, zoom),
                        tileRange = this._pxBoundsToTileRange(pixelBounds),
                        tileSize = this.getTileSize(),
                        tileCenter = pixelBounds.getCenter(),
                        tileZoom = zoom;
                    if (!(isFinite(tileCenter.x) && isFinite(tileCenter.y))) {
                        return;
                    }
                    var i, j, coords, coordsKey;
                    for (j = tileRange.min.y; j <= tileRange.max.y; j++) {
                        for (i = tileRange.min.x; i <= tileRange.max.x; i++) {
                            coords = new Atlas.Point(i, j);
                            coords.z = tileZoom;
                            coordsKey = this._tileCoordsToKey[coords];
                            if (this._isValidTile(coords)) {
                                if (!coordsKey) {
                                    this._addTile(coords);
                                }
                            } else if (coordsKey) {
                                this._removeTile(coordsKey);
                            }
                        }
                    }
                    for (i in this._tiles) {
                        if (this._tiles.hasOwnProperty(i)) {
                            coords = this._tiles[i].coords;
                            if (!pixelBounds.intersects(this._tileCoordsToBounds(coords))) {
                                this._removeTile(i);
                            }
                        }
                    }
                },
                _isValidTile: function (coords) {
                    var crs = this._map.options.crs;
                    if (!crs.infinite) {
                        var bounds = this._globalTileRange;
                        if ((!crs.wrapLng && (coords.x < bounds.min.x || coords.x > bounds.max.x)) ||
                            (!crs.wrapLat && (coords.y < bounds.min.y || coords.y > bounds.max.y))) {
                            return false;
                        }
                    }
                    if (!this.options.bounds) { return true; }
                    var tileBounds = this._tileCoordsToBounds(coords);
                    return Atlas.latLngBounds(this.options.bounds).intersects(tileBounds);
                },
                _getTilePixelBounds: function (center, zoom) {
                    var map = this._map,
                        scale = map.getZoomScale(zoom, this._tileZoom),
                        pixelCenter = map.project(center, zoom).floor(),
                        halfSize = map.getSize().divideBy(scale * 2);
                    return new Atlas.Bounds(pixelCenter.subtract(halfSize), pixelCenter.add(halfSize));
                },
                _pxBoundsToTileRange: function (bounds) {
                    var tileSize = this.getTileSize();
                    return new Atlas.Bounds(
                        bounds.min.unscaleBy(tileSize).floor(),
                        bounds.max.unscaleBy(tileSize).ceil().subtract(new Atlas.Point(1, 1))
                    );
                },
                _tileCoordsToBounds: function (coords) {
                    var map = this._map,
                        tileSize = this.getTileSize(),
                        nwPoint = coords.scaleBy(tileSize),
                        sePoint = nwPoint.add(tileSize),
                        nw = map.unproject(nwPoint, coords.z),
                        se = map.unproject(sePoint, coords.z),
                        bounds = new Atlas.LatLngBounds(nw, se);
                    if (!this.options.noWrap) {
                        map.wrapLatLngBounds(bounds);
                    }
                    return bounds;
                },
                _removeTilesAtZoom: function (zoom) {
                    for (var key in this._tiles) {
                        if (this._tiles.hasOwnProperty(key) && this._tiles[key].coords.z === zoom) {
                            this._removeTile(key);
                        }
                    }
                },
                _removeAllTiles: function () {
                    for (var key in this._tiles) {
                        if (this._tiles.hasOwnProperty(key)) {
                            this._removeTile(key);
                        }
                    }
                },
                _invalidateAll: function () {
                    for (var z in this._levels) {
                        Atlas.DomUtil.remove(this._levels[z].el);
                        this._onRemoveLevel(z);
                        delete this._levels[z];
                    }
                    this._removeAllTiles();
                    this._tileZoom = undefined;
                },
                _onRemoveLevel: function (zoom) {},
                _resetView: function (e) {
                    var animating = e && (e.pinch || e.flyTo);
                    this._setView(this._map.getCenter(), this._map.getZoom(), animating, animating);
                },
                _setView: function (center, zoom, noPrune, noUpdate) {
                    var tileZoom = Math.floor(zoom);
                    if ((this.options.maxZoom !== undefined && tileZoom > this.options.maxZoom) || 
                        (this.options.minZoom !== undefined && tileZoom < this.options.minZoom)) {
                        tileZoom = undefined;
                    }
                    var tileZoomChanged = this._tileZoom !== tileZoom;
                    if (!noUpdate || tileZoomChanged) {
                        this._tileZoom = tileZoom;
                        if (this._abortLoading) {
                            this._abortLoading();
                        }
                        this._invalidateAll();
                        if (tileZoom !== undefined) {
                            this._updateLevels();
                            this._resetGrid();
                            if (!noPrune) {
                                this._pruneTiles();
                            }
                            if (tileZoom) {
                                center = this._map.getCenter();
                            }
                            this._update(center);
                        }
                        if (!noPrune) {
                            this._pruneTiles();
                        }
                    }
                    this._setZoomTransforms(center, zoom);
                },
                _setZoomTransforms: function (center, zoom) {
                    for (var i in this._levels) {
                        if (this._levels.hasOwnProperty(i)) {
                            this._setZoomTransform(this._levels[i], center, zoom);
                        }
                    }
                },
                _setZoomTransform: function (level, center, zoom) {
                    var scale = this._map.getZoomScale(zoom, level.zoom),
                        translate = level.origin.multiplyBy(scale)
                            .subtract(this._map.project(center, zoom).floor());
                    if (Atlas.DomUtil.TRANSFORM) {
                        Atlas.DomUtil.setTransform(level.el, translate, scale);
                    } else {
                        level.el.style.zoom = scale;
                    }
                },
                _resetGrid: function () {
                    var map = this._map,
                        crs = map.options.crs,
                        tileSize = this.getTileSize(),
                        tileZoom = this._tileZoom;
                    var bounds = this._map.getPixelWorldBounds(this._tileZoom);
                    if (bounds) {
                        this._globalTileRange = this._pxBoundsToTileRange(bounds);
                    }
                    this._wrapX = crs.wrapLng && !this.options.noWrap && [
                        Math.floor(map.project([0, crs.wrapLng[0]], tileZoom).x / tileSize.x),
                        Math.ceil(map.project([0, crs.wrapLng[1]], tileZoom).x / tileSize.x)
                    ];
                    this._wrapY = crs.wrapLat && !this.options.noWrap && [
                        Math.floor(map.project([crs.wrapLat[0], 0], tileZoom).y / tileSize.y),
                        Math.ceil(map.project([crs.wrapLat[1], 0], tileZoom).y / tileSize.y)
                    ];
                },
                _onMoveEnd: function () {
                    if (!this._map || this._map._animatingZoom) { return; }
                    this._update();
                },
                _getTiledPixelBounds: function (center) {
                    var map = this._map,
                        mapZoom = map._animatingZoom ? Math.max(map._animateToZoom, map.getZoom()) : map.getZoom(),
                        scale = map.getZoomScale(mapZoom, this._tileZoom),
                        pixelCenter = map.project(center, this._tileZoom).floor(),
                        halfSize = map.getSize().divideBy(scale * 2);
                    return new Atlas.Bounds(pixelCenter.subtract(halfSize), pixelCenter.add(halfSize));
                },
                _wrapCoords: function (coords) {
                    var newCoords = new Atlas.Point(
                        this._wrapX ? Atlas.Util.wrapNum(coords.x, this._wrapX) : coords.x,
                        this._wrapY ? Atlas.Util.wrapNum(coords.y, this._wrapY) : coords.y
                    );
                    newCoords.z = coords.z;
                    return newCoords;
                },
                _pixelWrap: function (coords) {
                    var actualZoom = this._map.getZoom(),
                        currentZoom = this._tileZoom;
                    var scale = this._map.getZoomScale(currentZoom, actualZoom),
                        pixelOrigin = this._map.project(this._map.unproject(this._map.getPixelOrigin()), currentZoom)
                            ._round()
                            .subtract(this._map.getPixelOrigin());
                    return coords.scaleBy(scale).add(pixelOrigin);
                },
                _getWrapTileNum: function () {
                    var crs = this._map.options.crs,
                        size = this.getTileSize(),
                        zoom = this._tileZoom;
                    var wrapLng = crs.wrapLng && !this.options.noWrap ? [
                        Math.floor(this._map.project([0, crs.wrapLng[0]], zoom).x / size.x),
                        Math.ceil(this._map.project([0, crs.wrapLng[1]], zoom).x / size.x)
                    ] : [0, 0];
                    return wrapLng[1] - wrapLng[0] + 1;
                },
                _tileCoordsToKey: function (coords) {
                    return coords.x + ':' + coords.y + ':' + coords.z;
                },
                _keyToTileCoords: function (key) {
                    var k = key.split(':'),
                        coords = new Atlas.Point(+k[0], +k[1]);
                    coords.z = +k[2];
                    return coords;
                },
                _removeTile: function (key) {
                    var tile = this._tiles[key];
                    if (!tile) { return; }
                    Atlas.DomUtil.remove(tile.el);
                    delete this._tiles[key];
                    this.fire('tileunload', {
                        tile: tile.el,
                        coords: tile.coords
                    });
                },
                _initTile: function (tile) {
                    Atlas.DomUtil.addClass(tile, 'atlas-tile');
                    var tileSize = this.getTileSize();
                    tile.style.width = tileSize.x + 'px';
                    tile.style.height = tileSize.y + 'px';
                    if (tile.getAttribute('role') !== 'presentation') {
                        tile.setAttribute('role', 'presentation');
                    }
                },
                _addTile: function (coords, container) {
                    var tilePos = this._getTilePos(coords),
                        key = this._tileCoordsToKey(coords),
                        tile = this.createTile(coords, Atlas.Util.bind(this._tileReady, this, coords));
                    this._initTile(tile);
                    if (this.createTile) {
                        Atlas.DomUtil.setPosition(tile, tilePos);
                    }
                    this._tiles[key] = {
                        el: tile,
                        coords: coords,
                        currentPos: tilePos
                    };
                    container.appendChild(tile);
                    this.fire('tileloadstart', {
                        tile: tile,
                        coords: coords
                    });
                },
                _tileReady: function (coords, err, tile) {
                    if (err) {
                        this.fire('tileerror', {
                            error: err,
                            tile: tile,
                            coords: coords
                        });
                    }
                    var key = this._tileCoordsToKey(coords);
                    tile = this._tiles[key];
                    if (!tile) { return; }
                    tile.loaded = +new Date();
                    if (this._map.options.fadeAnimation) {
                        Atlas.DomUtil.setOpacity(tile.el, 0);
                        Atlas.Util.cancelAnimFrame(this._fadeFrame);
                        this._fadeFrame = Atlas.Util.requestAnimFrame(this._updateOpacity, this);
                    } else {
                        Atlas.DomUtil.setOpacity(tile.el, 1);
                        Atlas.DomUtil.addClass(tile.el, 'atlas-tile-loaded');
                    }
                    this.fire('tileload', {
                        tile: tile.el,
                        coords: coords
                    });
                },
                _pruneTiles: function () {
                    if (!this._map) {
                        return;
                    }
                    var key, tile;
                    var zoom = this._map.getZoom();
                    if (zoom > this.options.maxZoom ||
                        zoom < this.options.minZoom) {
                        this._removeAllTiles();
                        return;
                    }
                    for (key in this._tiles) {
                        if (this._tiles.hasOwnProperty(key)) {
                            tile = this._tiles[key];
                            tile.retain = tile.currentRetain;
                        }
                    }
                    for (key in this._tiles) {
                        if (this._tiles.hasOwnProperty(key)) {
                            tile = this._tiles[key];
                            if (tile.current > 1 && !tile.retain) {
                                this._removeTile(key);
                            }
                        }
                    }
                },
                _getTilePos: function (coords) {
                    return coords.scaleBy(this.getTileSize()).subtract(this._level.origin);
                },
                _wrapCoords: function (coords) {
                    var newCoords = new Atlas.Point(
                        this._wrapX ? Atlas.Util.wrapNum(coords.x, this._wrapX) : coords.x,
                        this._wrapY ? Atlas.Util.wrapNum(coords.y, this._wrapY) : coords.y
                    );
                    newCoords.z = coords.z;
                    return newCoords;
                },
                _animateZoom: function (e) {
                    if (!this._map) { return; }
                    this._setView(this._map.getCenter(), this._map.getZoom(), true, e.noUpdate);
                }
            });

            Atlas.TileLayer = Atlas.GridLayer.extend({
                options: {
                    minZoom: 0,
                    maxZoom: 18,
                    subdomains: 'abc',
                    errorTileUrl: '',
                    zoomOffset: 0,
                    tms: false,
                    zoomReverse: false,
                    detectRetina: false,
                    crossOrigin: false
                },
                initialize: function (url, options) {
                    this._url = url;
                    options = Atlas.Util.setOptions(this, options);
                    if (options.detectRetina && Atlas.Browser.retina && options.maxZoom > 0) {
                        options.tileSize = Math.floor(options.tileSize / 2);
                        options.zoomOffset++;
                        options.minZoom--;
                    }
                    if (typeof options.subdomains === 'string') {
                        options.subdomains = options.subdomains.split('');
                    }
                    if (!options.bounds) {
                        options.bounds = new Atlas.LatLngBounds([-90, -180], [90, 180]);
                    }
                    this.on('tileunload', this._onTileRemove);
                },
                onAdd: function (map) {
                    this._map = map;
                    if (map.options.zoomAnimation && Atlas.DomUtil.TRANSFORM) {
                        Atlas.DomUtil.addClass(this._container, 'atlas-zoom-animated');
                        this._zoomAnimated = true;
                    }
                    Atlas.GridLayer.prototype.onAdd.call(this, map);
                },
                getTileUrl: function (coords) {
                    var data = {
                        r: Atlas.Browser.retina ? '@2x' : '',
                        s: this._getSubdomain(coords),
                        x: coords.x,
                        y: this.options.tms ? this._globalTileRange.max.y - coords.y : coords.y,
                        z: this._getZoomForUrl()
                    };
                    if (this._map && !this._map.options.crs.infinite) {
                        var invertedY = this._globalTileRange.max.y - data.y;
                        if (this.options.tms) {
                            data.y = invertedY;
                        }
                    }
                    return Atlas.Util.template(this._url, Atlas.Util.extend(data, this.options));
                },
                createTile: function (coords, done) {
                    var tile = document.createElement('img');
                    Atlas.DomUtil.addClass(tile, 'atlas-tile');
                    tile.onload = Atlas.Util.bind(this._tileOnLoad, this, done, tile);
                    tile.onerror = Atlas.Util.bind(this._tileOnError, this, done, tile);
                    if (this.options.crossOrigin || this.options.crossOrigin === '') {
                        tile.crossOrigin = this.options.crossOrigin === true ? '' : this.options.crossOrigin;
                    }
                    tile.alt = '';
                    tile.src = this.getTileUrl(coords);
                    return tile;
                },
                _tileOnLoad: function (done, tile) {
                    Atlas.DomUtil.addClass(tile, 'atlas-tile-loaded');
                    done(null, tile);
                },
                _tileOnError: function (done, tile, e) {
                    var errorUrl = this.options.errorTileUrl;
                    if (errorUrl) {
                        tile.src = errorUrl;
                    }
                    done(e, tile);
                },
                _onTileRemove: function (e) {
                    e.tile.onload = null;
                },
                _getZoomForUrl: function () {
                    var zoom = this._tileZoom,
                        maxZoom = this.options.maxZoom,
                        zoomReverse = this.options.zoomReverse,
                        zoomOffset = this.options.zoomOffset;
                    if (zoomReverse) {
                        zoom = maxZoom - zoom;
                    }
                    return zoom + zoomOffset;
                },
                _getSubdomain: function (tilePoint) {
                    var index = Math.abs(tilePoint.x + tilePoint.y) % this.options.subdomains.length;
                    return this.options.subdomains[index];
                },
                getAttribution: function () {
                    return this.options.attribution;
                }
            });

            Atlas.tileLayer = function (url, options) {
                return new Atlas.TileLayer(url, options);
            };

            Atlas.Icon = Atlas.Class.extend({
                options: {
                    iconUrl: '',
                    iconRetinaUrl: '',
                    iconSize: [12, 12],
                    iconAnchor: null,
                    popupAnchor: null,
                    tooltipAnchor: [0, 0],
                    shadowUrl: '',
                    shadowRetinaUrl: '',
                    shadowSize: null,
                    shadowAnchor: null,
                    className: 'atlas-div-icon'
                },
                initialize: function (options) {
                    Atlas.Util.setOptions(this, options);
                },
                createIcon: function (oldIcon) {
                    return this._createIcon('icon', oldIcon);
                },
                createShadow: function (oldIcon) {
                    return this._createIcon('shadow', oldIcon);
                },
                _createIcon: function (name, oldIcon) {
                    var src = this._getIconUrl(name);
                    if (!src) {
                        if (name === 'icon') {
                            throw new Error('iconUrl not set in Icon options (see the docs).');
                        }
                        return null;
                    }
                    var img = Atlas.DomUtil.create('img', 'atlas-marker-' + name + ' ' + this.options.className);
                    if (oldIcon) {
                        Atlas.DomUtil.empty(oldIcon);
                        oldIcon.appendChild(img);
                    }
                    this._setIconStyles(img, name);
                    img.src = src;
                    return oldIcon || img;
                },
                _setIconStyles: function (img, name) {
                    var options = this.options,
                        sizeOption = options[name + 'Size'],
                        anchor;
                    if (typeof sizeOption === 'number') {
                        sizeOption = [sizeOption, sizeOption];
                    }
                    var size = Atlas.point(sizeOption),
                        anchor = Atlas.point(name === 'shadow' && options.shadowAnchor || options.iconAnchor ||
                            size && size.divideBy(2, true));
                    img.className = 'atlas-marker-' + name + ' ' + (options.className || '');
                    if (anchor) {
                        img.style.marginLeft = (-anchor.x) + 'px';
                        img.style.marginTop = (-anchor.y) + 'px';
                    }
                    if (size) {
                        img.style.width = size.x + 'px';
                        img.style.height = size.y + 'px';
                    }
                },
                _getIconUrl: function (name) {
                    return Atlas.Browser.retina && this.options[name + 'RetinaUrl'] || this.options[name + 'Url'];
                }
            });

            Atlas.Icon.Default = Atlas.Icon.extend({
                options: {
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    tooltipAnchor: [16, -28],
                    shadowSize: [41, 41]
                },
                _getIconUrl: function (name) {
                    if (name === 'icon') {
                        if (Atlas.Browser.retina && this.options.iconRetinaUrl) {
                            return this.options.iconRetinaUrl;
                        }
                        return this.options.iconUrl || Atlas.Icon.Default.imagePath + 'marker-icon.png';
                    } else if (name === 'shadow') {
                        if (Atlas.Browser.retina && this.options.shadowRetinaUrl) {
                            return this.options.shadowRetinaUrl;
                        }
                        return this.options.shadowUrl || Atlas.Icon.Default.imagePath + 'marker-shadow.png';
                    }
                }
            });

            Atlas.Icon.Default.imagePath = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/';

            Atlas.DivIcon = Atlas.Icon.extend({
                options: {
                    iconSize: [12, 12],
                    className: 'atlas-div-icon',
                    html: false
                },
                createIcon: function (oldIcon) {
                    var div = (oldIcon && oldIcon.tagName === 'DIV') ? oldIcon : document.createElement('div'),
                        options = this.options;
                    if (options.html !== false) {
                        div.innerHTML = options.html;
                    } else {
                        div.innerHTML = '';
                    }
                    if (options.bgPos) {
                        var bgPos = Atlas.point(options.bgPos);
                        div.style.backgroundPosition = (-bgPos.x) + 'px ' + (-bgPos.y) + 'px';
                    }
                    this._setIconStyles(div, 'icon');
                    return div;
                },
                createShadow: function () {
                    return null;
                }
            });

            Atlas.icon = function (options) {
                return new Atlas.Icon(options);
            };

            Atlas.divIcon = function (options) {
                return new Atlas.DivIcon(options);
            };

            Atlas.Marker = Atlas.Class.extend({
                includes: Atlas.Events,
                options: {
                    icon: new Atlas.Icon.Default(),
                    keyboard: true,
                    title: '',
                    alt: '',
                    zIndexOffset: 0,
                    opacity: 1,
                    riseOnHover: false,
                    riseOffset: 250,
                    pane: 'atlas-marker-pane',
                    shadowPane: 'atlas-shadow-pane',
                    bubblingMouseEvents: false,
                    draggable: false
                },
                initialize: function (latlng, options) {
                    Atlas.Util.setOptions(this, options);
                    this._latlng = Atlas.latLng(latlng);
                },
                onAdd: function (map) {
                    this._map = map;
                    map.on('zoomend viewreset', this.update, this);
                    this._zoomAnimated = map.options.zoomAnimation;
                    if (this._zoomAnimated) {
                        map.on('zoomanim', this._animateZoom, this);
                    }
                    this._initIcon();
                    this.update();
                    if (this.options.riseOnHover) {
                        Atlas.DomEvent.on(this._icon, {
                            mouseover: this._bringToFront,
                            mouseout: this._resetZIndex
                        }, this);
                    }
                    if (this.options.draggable) {
                        this.dragging = new Atlas.Handler.MarkerDrag(this);
                        if (this.options.draggable) {
                            this.dragging.enable();
                        }
                    }
                    this.fire('add');
                    if (map.hasLayer(this)) {
                        this.fire('add');
                    }
                },
                onRemove: function (map) {
                    if (this.dragging && this.dragging.enabled()) {
                        this.dragging.removeHooks();
                    }
                    if (this._icon) {
                        this._removeIcon();
                    }
                    if (this._shadow) {
                        this._removeShadow();
                    }
                    this._map = null;
                    map.off({
                        zoomend: this.update,
                        zoomanim: this._animateZoom,
                        viewreset: this.update
                    }, this);
                    if (this.options.riseOnHover) {
                        Atlas.DomEvent.off(this._icon, {
                            mouseover: this._bringToFront,
                            mouseout: this._resetZIndex
                        }, this);
                    }
                    this.fire('remove');
                },
                getLatLng: function () {
                    return this._latlng;
                },
                setLatLng: function (latlng) {
                    var oldLatLng = this._latlng;
                    this._latlng = Atlas.latLng(latlng);
                    this.update();
                    return this.fire('move', {oldLatLng: oldLatLng, latlng: this._latlng});
                },
                setZIndexOffset: function (offset) {
                    this.options.zIndexOffset = offset;
                    this.update();
                    return this;
                },
                getIcon: function () {
                    return this.options.icon;
                },
                setIcon: function (icon) {
                    this.options.icon = icon;
                    if (this._map) {
                        this._initIcon();
                        this.update();
                    }
                    if (this._popup) {
                        this.bindPopup(this._popup, this._popup.options);
                    }
                    return this;
                },
                getElement: function () {
                    return this._icon;
                },
                update: function () {
                    if (this._icon && this._map) {
                        var pos = this._map.latLngToLayerPoint(this._latlng).round();
                        this._setPos(pos);
                    }
                    return this;
                },
                _initIcon: function () {
                    var options = this.options,
                        classToAdd = 'atlas-zoom-' + (this._zoomAnimated ? 'animated' : 'hide');
                    var icon = options.icon.createIcon(this._icon),
                        addIcon = false;
                    if (icon !== this._icon) {
                        if (this._icon) {
                            this._removeIcon();
                        }
                        addIcon = true;
                        if (options.title) {
                            icon.title = options.title;
                        }
                        if (icon.tagName === 'IMG') {
                            icon.alt = options.alt || '';
                        }
                    }
                    Atlas.DomUtil.addClass(icon, classToAdd);
                    if (options.keyboard) {
                        icon.tabIndex = '0';
                    }
                    this._icon = icon;
                    if (options.riseOnHover) {
                        this._resetZIndex();
                    }
                    var newShadow = options.icon.createShadow(this._shadow),
                        addShadow = false;
                    if (newShadow !== this._shadow) {
                        this._removeShadow();
                        addShadow = true;
                    }
                    if (newShadow) {
                        Atlas.DomUtil.addClass(newShadow, classToAdd);
                        newShadow.alt = '';
                    }
                    this._shadow = newShadow;
                    if (options.opacity !== 1) {
                        this.setOpacity(options.opacity);
                    }
                    if (addIcon) {
                        this.getPane().appendChild(this._icon);
                    }
                    var panes = this._map._panes;
                    if (newShadow && addShadow) {
                        this.getPane(options.shadowPane).appendChild(this._shadow);
                    }
                },
                _removeIcon: function () {
                    if (this.options.riseOnHover) {
                        Atlas.DomEvent.off(this._icon, {
                            mouseover: this._bringToFront,
                            mouseout: this._resetZIndex
                        }, this);
                    }
                    Atlas.DomUtil.remove(this._icon);
                    this._icon = null;
                },
                _removeShadow: function () {
                    if (this._shadow) {
                        Atlas.DomUtil.remove(this._shadow);
                    }
                    this._shadow = null;
                },
                _setPos: function (pos) {
                    if (this._icon) {
                        Atlas.DomUtil.setPosition(this._icon, pos);
                    }
                    if (this._shadow) {
                        Atlas.DomUtil.setPosition(this._shadow, pos);
                    }
                    this._zIndex = pos.y + this.options.zIndexOffset;
                    this._resetZIndex();
                },
                _resetZIndex: function () {
                    if (this._icon) {
                        this._icon.style.zIndex = this._zIndex;
                    }
                    if (this._shadow) {
                        this._shadow.style.zIndex = this._zIndex - 1;
                    }
                },
                _bringToFront: function () {
                    this._icon.style.zIndex = this._zIndex + this.options.riseOffset;
                    this._shadow.style.zIndex = this._zIndex + this.options.riseOffset - 1;
                },
                _resetState: function () {
                    this._bringToFront = Atlas.Util.falseFn;
                    this._resetState = Atlas.Util.falseFn;
                },
                _animateZoom: function (opt) {
                    var pos = this._map._latLngToNewLayerPoint(this._latlng, opt.zoom, opt.center).round();
                    this._setPos(pos);
                },
                _getIconUrl: function (name) {
                    return Atlas.Browser.retina && this.options[name + 'RetinaUrl'] || this.options[name + 'Url'];
                },
                setOpacity: function (opacity) {
                    this.options.opacity = opacity;
                    if (this._icon) {
                        Atlas.DomUtil.setOpacity(this._icon, opacity);
                    }
                    if (this._shadow) {
                        Atlas.DomUtil.setOpacity(this._shadow, opacity);
                    }
                    return this;
                },
                bringToFront: function () {
                    if (this._icon) {
                        Atlas.DomUtil.toFront(this._icon);
                    }
                    if (this._shadow) {
                        Atlas.DomUtil.toFront(this._shadow);
                    }
                    return this;
                },
                bringToBack: function () {
                    if (this._icon) {
                        Atlas.DomUtil.toBack(this._icon);
                    }
                    if (this._shadow) {
                        Atlas.DomUtil.toBack(this._shadow);
                    }
                    return this;
                },
                bindPopup: function (content, options) {
                    if (content instanceof Atlas.Popup) {
                        Atlas.setOptions(content, options);
                        this._popup = content;
                        content._source = this;
                    } else {
                        if (!this._popup || options) {
                            this._popup = new Atlas.Popup(options, this);
                        }
                        this._popup.setContent(content);
                    }
                    if (!this._popupHandlersAdded) {
                        this.on({
                            click: this.togglePopup,
                            remove: this.closePopup,
                            move: this._movePopup
                        });
                        this._popupHandlersAdded = true;
                    }
                    return this;
                },
                unbindPopup: function () {
                    if (this._popup) {
                        this.off({
                            click: this.togglePopup,
                            remove: this.closePopup,
                            move: this._movePopup
                        });
                        this._popupHandlersAdded = false;
                        this._popup = null;
                    }
                    return this;
                },
                openPopup: function (latlng) {
                    if (this._popup && this._map) {
                        latlng = latlng || this._latlng;
                        this._openPopup(latlng);
                    }
                    return this;
                },
                closePopup: function () {
                    if (this._popup) {
                        this._popup._close();
                    }
                    return this;
                },
                togglePopup: function (e) {
                    if (this._popup) {
                        if (this._popup._map) {
                            this.closePopup();
                        } else {
                            this._openPopup(e.latlng);
                        }
                    }
                },
                _openPopup: function (latlng) {
                    var left = this._popup.options.offset.x < 0,
                        options = Atlas.Util.extend({}, this._popup.options);
                    if (left) {
                        options.offset = new Atlas.Point(-(this._popup.options.offset.x), this._popup.options.offset.y);
                    }
                    this._popup.setLatLng(latlng).openOn(this._map);
                },
                _movePopup: function (e) {
                    this._popup.setLatLng(e.latlng);
                },
                getPopup: function () {
                    return this._popup;
                },
                bindTooltip: function (content, options) {
                    if (content instanceof Atlas.Tooltip) {
                        Atlas.setOptions(content, options);
                        this._tooltip = content;
                        content._source = this;
                    } else {
                        if (!this._tooltip || options) {
                            this._tooltip = new Atlas.Tooltip(options, this);
                        }
                        this._tooltip.setContent(content);
                    }
                    this._initInteraction();
                    if (this._tooltip.options.permanent) {
                        this._map.addLayer(this._tooltip);
                    }
                    return this;
                },
                unbindTooltip: function () {
                    if (this._tooltip) {
                        this._initInteraction();
                        this.closeTooltip();
                        this._tooltip = null;
                    }
                    return this;
                },
                openTooltip: function (latlng) {
                    if (this._tooltip && this._map) {
                        latlng = latlng || this._latlng;
                        if (this._tooltip._prepareOpen(this, latlng)) {
                            this._map.addLayer(this._tooltip);
                        }
                    }
                    return this;
                },
                closeTooltip: function () {
                    if (this._tooltip) {
                        this._tooltip.close();
                    }
                    return this;
                },
                toggleTooltip: function (e) {
                    if (this._tooltip) {
                        if (this._tooltip._map) {
                            this.closeTooltip();
                        } else {
                            if (e.latlng) {
                                this._openTooltip(e.latlng);
                            } else {
                                this._openTooltip(this._latlng);
                            }
                        }
                    }
                },
                _openTooltip: function (latlng) {
                    if (this._tooltip && this._map) {
                        this._tooltip._source = this;
                        this._tooltip.updatePosition(latlng);
                        if (!this._map.hasLayer(this._tooltip)) {
                            this._map.addLayer(this._tooltip);
                        }
                    }
                },
                getTooltip: function () {
                    return this._tooltip;
                },
                _initInteraction: function () {
                    if (!this.options.interactive) { return; }
                    Atlas.DomUtil.addClass(this._icon, 'atlas-interactive');
                    this.addInteractiveTarget(this._icon);
                    if (this._shadow) {
                        this.addInteractiveTarget(this._shadow);
                    }
                },
                addInteractiveTarget: function (targetEl) {
                    this._map._targets[Atlas.Util.stamp(targetEl)] = this;
                },
                removeInteractiveTarget: function (targetEl) {
                    delete this._map._targets[Atlas.Util.stamp(targetEl)];
                }
            });

            Atlas.marker = function (latlng, options) {
                return new Atlas.Marker(latlng, options);
            };

            Atlas.Handler.MarkerDrag = Atlas.Handler.extend({
                initialize: function (marker) {
                    this._marker = marker;
                },
                addHooks: function () {
                    var icon = this._marker._icon;
                    if (!this._draggable) {
                        this._draggable = new Atlas.Draggable(icon, icon, true);
                    }
                    this._draggable.on({
                        dragstart: this._onDragStart,
                        drag: this._onDrag,
                        dragend: this._onDragEnd
                    }, this).enable();
                    Atlas.DomUtil.addClass(icon, 'atlas-marker-draggable');
                },
                removeHooks: function () {
                    this._draggable.off({
                        dragstart: this._onDragStart,
                        drag: this._onDrag,
                        dragend: this._onDragEnd
                    }, this).disable();
                    if (this._marker._icon) {
                        Atlas.DomUtil.removeClass(this._marker._icon, 'atlas-marker-draggable');
                    }
                },
                moved: function () {
                    return this._draggable && this._draggable._moved;
                },
                _adjustPan: function (e) {
                    var marker = this._marker,
                        map = marker._map,
                        speed = this._marker.options.autoPanSpeed,
                        padding = this._marker.options.autoPanPadding,
                        pos = Atlas.DomUtil.getPosition(marker._icon),
                        bounds = map.getPixelBounds(),
                        origin = map.getPixelOrigin();
                    var panBounds = new Atlas.Bounds(
                        bounds.min._add(origin).add(padding),
                        bounds.max._add(origin).subtract(padding)
                    );
                    if (!panBounds.contains(pos)) {
                        var movement = new Atlas.Point(
                            (Math.max(panBounds.max.x, pos.x) - panBounds.max.x) || (Math.min(panBounds.min.x, pos.x) - panBounds.min.x),
                            (Math.max(panBounds.max.y, pos.y) - panBounds.max.y) || (Math.min(panBounds.min.y, pos.y) - panBounds.min.y)
                        );
                        map.panBy(movement, {animate: false});
                        this._draggable._newPos._add(movement);
                        this._draggable._startPos._add(movement);
                        Atlas.DomUtil.setPosition(marker._icon, this._draggable._newPos);
                        this._onDrag(e);
                        this._panRequest = Atlas.Util.requestAnimFrame(this._adjustPan.bind(this, e));
                    }
                },
                _onDragStart: function () {
                    this._oldLatLng = this._marker.getLatLng();
                    this._marker
                        .closePopup()
                        .fire('movestart')
                        .fire('dragstart');
                },
                _onDrag: function (e) {
                    var marker = this._marker,
                        shadow = marker._shadow,
                        iconPos = Atlas.DomUtil.getPosition(marker._icon),
                        latlng = marker._map.layerPointToLatLng(iconPos);
                    if (shadow) {
                        Atlas.DomUtil.setPosition(shadow, iconPos);
                    }
                    marker._latlng = latlng;
                    e.latlng = latlng;
                    e.oldLatLng = this._oldLatLng;
                    marker
                        .fire('move', e)
                        .fire('drag', e);
                },
                _onDragEnd: function (e) {
                    Atlas.Util.cancelAnimFrame(this._panRequest);
                    delete this._oldLatLng;
                    this._marker
                        .fire('moveend')
                        .fire('dragend', e);
                }
            });

            Atlas.DivOverlay = Atlas.Class.extend({
                options: {
                    offset: [0, 7],
                    className: '',
                    pane: 'atlas-popup-pane'
                },
                initialize: function (options, source) {
                    Atlas.Util.setOptions(this, options);
                    this._source = source;
                },
                onAdd: function (map) {
                    this._map = map;
                    if (!this._container) {
                        this._initLayout();
                    }
                    this._updateLayout();
                    this._updatePosition();
                    this._map._panes.popupPane.appendChild(this._container);
                    this._map.on(this._getEvents(), this);
                    if (this._zoomAnimated) {
                        Atlas.DomUtil.addClass(this._container, 'atlas-zoom-animated');
                    }
                    this._adjustPan();
                },
                onRemove: function (map) {
                    map.off(this._getEvents(), this);
                    Atlas.DomUtil.remove(this._container);
                    this._map = null;
                },
                _getEvents: function () {
                    var events = {
                        zoom: this._updatePosition,
                        viewreset: this._updatePosition
                    };
                    if (this._zoomAnimated) {
                        events.zoomanim = this._animateZoom;
                    }
                    return events;
                },
                _updateLayout: function () {},
                _updatePosition: function () {
                    if (!this._map) { return; }
                    var pos = this._map.latLngToLayerPoint(this._latlng),
                        offset = Atlas.point(this.options.offset);
                    if (this._anchor) {
                        var anchor = this._anchor;
                        pos = pos.add(new Atlas.Point(-anchor.x + offset.x, -anchor.y + offset.y));
                    } else {
                        pos = pos.add(offset);
                    }
                    Atlas.DomUtil.setPosition(this._container, pos);
                },
                _animateZoom: function (e) {
                    var pos = this._map._latLngToNewLayerPoint(this._latlng, e.zoom, e.center).add(this.options.offset);
                    Atlas.DomUtil.setTransform(this._container, pos);
                },
                _adjustPan: function () {
                    if (!this.options.autoPan || (this._map._panAnim && this._map._panAnim._inProgress)) { return; }
                    var map = this._map,
                        marginBottom = parseInt(Atlas.DomUtil.getStyle(this._container, 'marginBottom'), 10) || 0,
                        containerHeight = this._container.offsetHeight + marginBottom,
                        containerWidth = this._container.offsetWidth,
                        layerPos = new Atlas.Point(this._container.left, this._container.top);
                    if (this._container._atlas_pos) {
                        layerPos = this._container._atlas_pos;
                    }
                    var containerPos = map.layerPointToContainerPoint(layerPos),
                        padding = Atlas.point(this.options.autoPanPadding),
                        paddingTL = Atlas.point(this.options.autoPanPaddingTopLeft || padding),
                        paddingBR = Atlas.point(this.options.autoPanPaddingBottomRight || padding),
                        size = map.getSize(),
                        dx = 0,
                        dy = 0;
                    if (containerPos.x + containerWidth + paddingBR.x > size.x) {
                        dx = containerPos.x + containerWidth - size.x + paddingBR.x;
                    }
                    if (containerPos.x - dx - paddingTL.x < 0) {
                        dx = containerPos.x - paddingTL.x;
                    }
                    if (containerPos.y + containerHeight + paddingBR.y > size.y) {
                        dy = containerPos.y + containerHeight - size.y + paddingBR.y;
                    }
                    if (containerPos.y - dy - paddingTL.y < 0) {
                        dy = containerPos.y - paddingTL.y;
                    }
                    if (dx || dy) {
                        map.panBy(new Atlas.Point(dx, dy));
                    }
                }
            });

            Atlas.Popup = Atlas.DivOverlay.extend({
                options: {
                    maxWidth: 300,
                    minWidth: 50,
                    maxHeight: null,
                    autoPan: true,
                    autoPanPaddingTopLeft: null,
                    autoPanPaddingBottomRight: null,
                    autoPanPadding: [5, 5],
                    keepInView: false,
                    closeButton: true,
                    autoClose: true,
                    closeOnEscapeKey: true,
                },
                initialize: function (options, source) {
                    Atlas.Util.setOptions(this, options);
                    this._source = source;
                    this._animated = Atlas.DomUtil.TRANSITION && Atlas.Browser.any3d;
                },
                onAdd: function (map) {
                    Atlas.DivOverlay.prototype.onAdd.call(this, map);
                    map.on('click', this._close, this);
                    this._updateLayout();
                },
                onRemove: function (map) {
                    map.off('click', this._close, this);
                    Atlas.DivOverlay.prototype.onRemove.call(this, map);
                },
                _initLayout: function () {
                    var prefix = 'atlas-popup',
                        container = this._container = Atlas.DomUtil.create('div', prefix + ' ' + (this.options.className || '') + ' atlas-zoom-animated');
                    if (this._animated) {
                        Atlas.DomUtil.addClass(container, 'atlas-fade-anim');
                    }
                    var wrapper = this._wrapper = Atlas.DomUtil.create('div', prefix + '-content-wrapper', container);
                    this._contentNode = Atlas.DomUtil.create('div', prefix + '-content', wrapper);
                    Atlas.DomEvent.disableClickPropagation(wrapper);
                    Atlas.DomEvent.on(wrapper, 'contextmenu', Atlas.DomEvent.stopPropagation);
                    this._tipContainer = Atlas.DomUtil.create('div', prefix + '-tip-container', container);
                    this._tip = Atlas.DomUtil.create('div', prefix + '-tip', this._tipContainer);
                    if (this.options.closeButton) {
                        var closeButton = this._closeButton = Atlas.DomUtil.create('a', prefix + '-close-button', container);
                        closeButton.href = '#close';
                        closeButton.innerHTML = '&#215;';
                        Atlas.DomEvent.on(closeButton, 'click', this._onCloseButtonClick, this);
                    }
                },
                _updateLayout: function () {
                    var container = this._contentNode,
                        style = container.style;
                    style.width = '';
                    style.whiteSpace = 'nowrap';
                    var width = container.offsetWidth;
                    width = Math.min(width, this.options.maxWidth);
                    width = Math.max(width, this.options.minWidth);
                    style.width = (width + 1) + 'px';
                    style.whiteSpace = '';
                    style.height = '';
                    var height = container.offsetHeight,
                        maxHeight = this.options.maxHeight,
                        scrolledClass = 'atlas-popup-scrolled';
                    if (maxHeight && height > maxHeight) {
                        style.height = maxHeight + 'px';
                        Atlas.DomUtil.addClass(container, scrolledClass);
                    } else {
                        Atlas.DomUtil.removeClass(container, scrolledClass);
                    }
                    this._containerWidth = this._container.offsetWidth;
                },
                _animateZoom: function (e) {
                    var pos = this._map._latLngToNewLayerPoint(this._latlng, e.zoom, e.center), offset = this.options.offset;
                    pos.x += offset.x;
                    pos.y += offset.y;
                    Atlas.DomUtil.setTransform(this._container, pos);
                },
                _adjustPan: function () {
                    if (!this.options.autoPan || (this._map._panAnim && this._map._panAnim._inProgress)) { return; }
                    var map = this._map,
                        marginBottom = parseInt(Atlas.DomUtil.getStyle(this._container, 'marginBottom'), 10) || 0,
                        containerHeight = this._container.offsetHeight + marginBottom,
                        containerWidth = this._containerWidth,
                        layerPos = new Atlas.Point(this._container.left, this._container.top);
                    if (this._container._atlas_pos) {
                        layerPos = this._container._atlas_pos;
                    }
                    var containerPos = map.layerPointToContainerPoint(layerPos),
                        padding = Atlas.point(this.options.autoPanPadding),
                        paddingTL = Atlas.point(this.options.autoPanPaddingTopLeft || padding),
                        paddingBR = Atlas.point(this.options.autoPanPaddingBottomRight || padding),
                        size = map.getSize(),
                        dx = 0,
                        dy = 0;
                    if (containerPos.x + containerWidth + paddingBR.x > size.x) {
                        dx = containerPos.x + containerWidth - size.x + paddingBR.x;
                    }
                    if (containerPos.x - dx - paddingTL.x < 0) {
                        dx = containerPos.x - paddingTL.x;
                    }
                    if (containerPos.y + containerHeight + paddingBR.y > size.y) {
                        dy = containerPos.y + containerHeight - size.y + paddingBR.y;
                    }
                    if (containerPos.y - dy - paddingTL.y < 0) {
                        dy = containerPos.y - paddingTL.y;
                    }
                    if (dx || dy) {
                        map.panBy(new Atlas.Point(dx, dy));
                    }
                },
                _updatePosition: function () {
                    if (!this._map) { return; }
                    var pos = this._map.latLngToLayerPoint(this._latlng),
                        animated = this._animated,
                        offset = Atlas.point(this.options.offset);
                    if (this._source && this._source._latlng === this._latlng) {
                        var latlng = this._source._latlng;
                        var anchor = null;
                        if (this._source && this._source.options.icon) {
                            anchor = this._source.options.icon.options.popupAnchor;
                        }
                        if (anchor) {
                            anchor = Atlas.point(anchor);
                        } else {
                            anchor = Atlas.point(0, this._source._containerHeight + 16);
                        }
                        pos = pos.add(anchor);
                    } else {
                        pos = pos.add(offset);
                    }
                    var bottom = pos.y - this._containerHeight - 12;
                    this._containerBottom = -bottom;
                    if (animated) {
                        Atlas.DomUtil.setPosition(this._container, pos);
                        this._container.style.bottom = this._containerBottom + 'px';
                    } else {
                        Atlas.DomUtil.setPosition(this._container, new Atlas.Point(pos.x, bottom));
                    }
                    this._container._atlas_pos = pos;
                },
                _setContent: function (content) {
                    if (typeof content === 'string') {
                        this._contentNode.innerHTML = content;
                    } else {
                        while (this._contentNode.hasChildNodes()) {
                            this._contentNode.removeChild(this._contentNode.firstChild);
                        }
                        this._contentNode.appendChild(content);
                    }
                    this._updateLayout();
                },
                setContent: function (content) {
                    this._content = content;
                    this.update();
                    return this;
                },
                getContent: function () {
                    return this._content;
                },
                getElement: function () {
                    return this._container;
                },
                update: function () {
                    if (!this._map) { return; }
                    this._container.style.visibility = 'hidden';
                    this._updateContent();
                    this._updateLayout();
                    this._updatePosition();
                    this._container.style.visibility = '';
                    this._adjustPan();
                },
                getLatLng: function () {
                    return this._latlng;
                },
                setLatLng: function (latlng) {
                    this._latlng = Atlas.latLng(latlng);
                    if (this._map) {
                        this._updatePosition();
                        this._adjustPan();
                    }
                    return this;
                },
                _updateContent: function () {
                    if (!this._content) { return; }
                    var node = this._contentNode;
                    var content = (typeof this._content === 'function') ? this._content(this._source || this) : this._content;
                    if (typeof content === 'string') {
                        node.innerHTML = content;
                    } else {
                        while (node.hasChildNodes()) {
                            node.removeChild(node.firstChild);
                        }
                        node.appendChild(content);
                    }
                },
                _close: function () {
                    if (this._map) {
                        this._map.closePopup(this);
                    }
                },
                _onCloseButtonClick: function (e) {
                    this._close();
                    Atlas.DomEvent.stop(e);
                }
            });

            Atlas.popup = function (options, source) {
                return new Atlas.Popup(options, source);
            };

            Atlas.Tooltip = Atlas.DivOverlay.extend({
                options: {
                    pane: 'atlas-tooltip-pane',
                    offset: [0, 0],
                    direction: 'auto',
                    permanent: false,
                    sticky: false,
                    interactive: false,
                    opacity: 0.9
                },
                initialize: function (options, source) {
                    Atlas.Util.setOptions(this, options);
                    this._source = source;
                    this._animated = Atlas.DomUtil.TRANSITION && Atlas.Browser.any3d;
                },
                onAdd: function (map) {
                    Atlas.DivOverlay.prototype.onAdd.call(this, map);
                    if (this.options.interactive) {
                        Atlas.DomUtil.addClass(this._container, 'atlas-interactive');
                        this.addInteractiveTarget(this._container);
                    }
                },
                _initLayout: function () {
                    var prefix = 'atlas-tooltip',
                        className = prefix + ' ' + (this.options.className || '') + ' atlas-zoom-' + (this._zoomAnimated ? 'animated' : 'hide');
                    this._contentNode = this._container = Atlas.DomUtil.create('div', className);
                },
                _updateLayout: function () {
                    var tooltipWidth = this._container.offsetWidth,
                        tooltipHeight = this._container.offsetHeight,
                        options = this.options,
                        anchor = options.anchor;
                    this._anchor = anchor || new Atlas.Point(tooltipWidth / 2, tooltipHeight);
                },
                _updatePosition: function () {
                    var pos = this._map.latLngToLayerPoint(this._latlng);
                    this._setPosition(pos);
                },
                _setPosition: function (pos) {
                    var map = this._map,
                        container = this._container,
                        centerPoint = map.latLngToContainerPoint(map.getCenter()),
                        tooltipPoint = map.containerPointToLayerPoint(centerPoint),
                        direction = this.options.direction,
                        tooltipWidth = this._container.offsetWidth,
                        tooltipHeight = this._container.offsetHeight,
                        offset = Atlas.point(this.options.offset),
                        anchor = this._anchor;
                    if (direction === 'top') {
                        pos = pos.add(new Atlas.Point(-tooltipWidth / 2 + anchor.x, -tooltipHeight + offset.y));
                    } else if (direction === 'bottom') {
                        pos = pos.add(new Atlas.Point(-tooltipWidth / 2 + anchor.x, offset.y));
                    } else if (direction === 'center') {
                        pos = pos.add(new Atlas.Point(-tooltipWidth / 2 + offset.x, -tooltipHeight / 2 - anchor.y + offset.y));
                    } else if (direction === 'auto') {
                        if (pos.y + tooltipHeight + offset.y < tooltipPoint.y) {
                            direction = 'top';
                        } else {
                            direction = 'bottom';
                        }
                        this._setPosition(pos);
                        return;
                    }
                    Atlas.DomUtil.setPosition(container, pos);
                },
                _updateContent: function () {
                    var content = this._content;
                    if (typeof content === 'function') {
                        content = content(this._source);
                    }
                    if (!content) {
                        this._container.style.visibility = 'hidden';
                        return;
                    }
                    if (typeof content === 'string') {
                        this._container.innerHTML = content;
                    } else {
                        while (this._container.hasChildNodes()) {
                            this._container.removeChild(this._container.firstChild);
                        }
                        this._container.appendChild(content);
                    }
                    this._container.style.visibility = '';
                },
                setContent: function (content) {
                    this._content = content;
                    this.update();
                    return this;
                },
                getContent: function () {
                    return this._content;
                },
                getElement: function () {
                    return this._container;
                },
                update: function () {
                    if (!this._map) { return; }
                    this._container.style.visibility = 'hidden';
                    this._updateContent();
                    this._updateLayout();
                    this._setPosition(this._map.latLngToLayerPoint(this._latlng));
                    this._container.style.visibility = '';
                },
                getLatLng: function () {
                    return this._latlng;
                },
                setLatLng: function (latlng) {
                    this._latlng = Atlas.latLng(latlng);
                    this.update();
                    return this;
                }
            });

            Atlas.tooltip = function (options, source) {
                return new Atlas.Tooltip(options, source);
            };

            Atlas.Map.include({
                openPopup: function (popup, latlng, options) {
                    if (!(popup instanceof Atlas.Popup)) {
                        popup = new Atlas.Popup(options).setContent(popup);
                    }
                    if (latlng) {
                        popup.setLatLng(latlng);
                    }
                    if (this.hasLayer(popup)) {
                        return this;
                    }
                    if (this._popup && this._popup.options.autoClose) {
                        this.closePopup();
                    }
                    this._popup = popup;
                    return this.addLayer(popup);
                },
                openTooltip: function (tooltip, latlng, options) {
                    if (!(tooltip instanceof Atlas.Tooltip)) {
                        tooltip = new Atlas.Tooltip(options).setContent(tooltip);
                    }
                    if (latlng) {
                        tooltip.setLatLng(latlng);
                    }
                    if (this.hasLayer(tooltip)) {
                        return this;
                    }
                    if (this._tooltip) {
                        this.closeTooltip();
                    }
                    this._tooltip = tooltip;
                    return this.addLayer(tooltip);
                },
                closePopup: function (popup) {
                    if (!popup || popup === this._popup) {
                        popup = this._popup;
                        this._popup = null;
                    }
                    if (popup) {
                        this.removeLayer(popup);
                    }
                    return this;
                },
                closeTooltip: function (tooltip) {
                    if (!tooltip || tooltip === this._tooltip) {
                        tooltip = this._tooltip;
                        this._tooltip = null;
                    }
                    if (tooltip) {
                        this.removeLayer(tooltip);
                    }
                    return this;
                }
            });

            Atlas.Layer = Atlas.Class.extend({
                includes: Atlas.Events,
                initialize: function () {}
            });

            Atlas.Layer.include = function (props) {
                Atlas.Util.extend(this.prototype, props);
            };

            Atlas.Layer.include({
                bindPopup: function (content, options) {
                    this._popup = new Atlas.Popup(options, this)._setContent(content);
                    if (!this._popupHandlersAdded) {
                        this.on({
                            click: this.togglePopup,
                            remove: this.closePopup,
                            move: this._movePopup
                        });
                        this._popupHandlersAdded = true;
                    }
                    return this;
                },
                unbindPopup: function () {
                    if (this._popup) {
                        this.off({
                            click: this.togglePopup,
                            remove: this.closePopup,
                            move: this._movePopup
                        });
                        this._popupHandlersAdded = false;
                        this._popup = null;
                    }
                    return this;
                },
                openPopup: function (latlng) {
                    if (this._popup) {
                        if (latlng) {
                            this._popup.setLatLng(latlng);
                        } else if (this._latlng || this._latlngs || this._bounds) {
                            this._popup.setLatLng(this._latlng || this._latlngs[Math.floor(this._latlngs.length / 2)] || this._bounds.getCenter());
                        }
                        this._map.openPopup(this._popup);
                    }
                    return this;
                },
                closePopup: function () {
                    if (this._popup) {
                        this._popup._close();
                    }
                    return this;
                },
                togglePopup: function (e) {
                    if (this._popup) {
                        if (!this._map.hasLayer(this._popup)) {
                            this.openPopup(e.latlng);
                        } else {
                            this.closePopup();
                        }
                    }
                },
                bindTooltip: function (content, options) {
                    this._tooltip = new Atlas.Tooltip(options, this)._setContent(content);
                    if (!this._tooltipHandlersAdded) {
                        this.on({
                            mouseover: this._openTooltip,
                            mouseout: this.closeTooltip,
                            remove: this.closeTooltip
                        });
                        this._tooltipHandlersAdded = true;
                    }
                    if (this._tooltip.options.permanent) {
                        this._openTooltip();
                    }
                    return this;
                },
                unbindTooltip: function () {
                    if (this._tooltip) {
                        this.off({
                            mouseover: this._openTooltip,
                            mouseout: this.closeTooltip,
                            remove: this.closeTooltip
                        });
                        this._tooltipHandlersAdded = false;
                        this._tooltip = null;
                    }
                    return this;
                },
                openTooltip: function (latlng) {
                    if (this._tooltip && this._tooltip._prepareOpen(this, latlng)) {
                        this._map.openTooltip(this._tooltip);
                    }
                    return this;
                },
                closeTooltip: function () {
                    if (this._tooltip) {
                        this._tooltip.close();
                    }
                    return this;
                },
                _openTooltip: function (e) {
                    if (!this._tooltip || !this._tooltip.options.permanent) {
                        return;
                    }
                    var latlng = e.latlng || this._latlng || this.getCenter();
                    if (this._tooltip._prepareOpen(this, latlng, e)) {
                        this.openTooltip(latlng);
                    }
                }
            });

            Atlas.SVG = Atlas.Renderer.extend({
                _update: function () {
                    if (this._map._animatingZoom && !Atlas.Browser.gecko) {
                        return;
                    }
                    Atlas.Renderer.prototype._update.call(this);
                    this._rootGroup.setAttribute('transform', this._pathRoot.attr('transform'));
                },
                _initPath: function (layer) {
                    var path = layer._path = Atlas.SVG.create('path');
                    if (layer.options.className) {
                        Atlas.DomUtil.addClass(path, layer.options.className);
                    }
                    if (layer.options.interactive) {
                        Atlas.DomUtil.addClass(path, 'atlas-interactive');
                    }
                    this._updateStyle(layer);
                    this._rootGroup.appendChild(path);
                },
                _addPath: function (layer) {
                    this._rootGroup.appendChild(layer._path);
                },
                _removePath: function (layer) {
                    Atlas.DomUtil.remove(layer._path);
                },
                _updatePath: function (layer) {
                    layer._project();
                    layer._update();
                },
                _updateStyle: function (layer) {
                    var path = layer._path,
                        options = layer.options;
                    if (!path) { return; }
                    if (options.stroke) {
                        path.setAttribute('stroke', options.color);
                        path.setAttribute('stroke-opacity', options.opacity);
                        path.setAttribute('stroke-width', options.weight);
                        path.setAttribute('stroke-linecap', options.lineCap);
                        path.setAttribute('stroke-linejoin', options.lineJoin);
                        if (options.dashArray) {
                            path.setAttribute('stroke-dasharray', options.dashArray);
                        } else {
                            path.removeAttribute('stroke-dasharray');
                        }
                        if (options.dashOffset) {
                            path.setAttribute('stroke-dashoffset', options.dashOffset);
                        } else {
                            path.removeAttribute('stroke-dashoffset');
                        }
                    } else {
                        path.setAttribute('stroke', 'none');
                    }
                    if (options.fill) {
                        path.setAttribute('fill', options.fillColor || options.color);
                        path.setAttribute('fill-opacity', options.fillOpacity);
                        path.setAttribute('fill-rule', options.fillRule || 'evenodd');
                    } else {
                        path.setAttribute('fill', 'none');
                    }
                },
                _updatePoly: function (layer, closed) {
                    this._setPath(layer, Atlas.SVG.pointsToPath(layer._parts, closed));
                },
                _updateCircle: function (layer) {
                    var p = layer._point,
                        r = Math.max(Math.round(layer._radius), 1),
                        r2 = Math.max(Math.round(layer._radiusY), 1) || r,
                        arc = 'a' + r + ',' + r2 + ' 0 1,0 ';
                    var d = layer._empty() ? 'M0 0' :
                        'M' + (p.x - r) + ',' + p.y +
                        arc + (r * 2) + ',0 ' +
                        arc + (-r * 2) + ',0 ';
                    this._setPath(layer, d);
                },
                _setPath: function (layer, path) {
                    layer._path.setAttribute('d', path);
                },
                _bringToFront: function (layer) {
                    Atlas.DomUtil.toFront(layer._path);
                },
                _bringToBack: function (layer) {
                    Atlas.DomUtil.toBack(layer._path);
                }
            });

            Atlas.Path = Atlas.Class.extend({
                includes: [Atlas.Events],
                options: {
                    stroke: true,
                    color: '#3388ff',
                    weight: 3,
                    opacity: 1,
                    lineCap: 'round',
                    lineJoin: 'round',
                    dashArray: null,
                    dashOffset: null,
                    fill: false,
                    fillColor: null,
                    fillOpacity: 0.2,
                    fillRule: 'evenodd',
                    interactive: true,
                    bubblingMouseEvents: true
                },
                beforeAdd: function (map) {
                    this._renderer = map.getRenderer(this);
                },
                onAdd: function () {
                    this._renderer._initPath(this);
                    this._reset();
                    this._renderer._addPath(this);
                },
                onRemove: function () {
                    this._renderer._removePath(this);
                },
                redraw: function () {
                    if (this._map) {
                        this._renderer._updatePath(this);
                    }
                    return this;
                },
                setStyle: function (style) {
                    Atlas.Util.setOptions(this, style);
                    if (this._renderer) {
                        this._renderer._updateStyle(this);
                    }
                    return this;
                },
                bringToFront: function () {
                    if (this._renderer) {
                        this._renderer._bringToFront(this);
                    }
                    return this;
                },
                bringToBack: function () {
                    if (this._renderer) {
                        this._renderer._bringToBack(this);
                    }
                    return this;
                },
                _reset: function () {},
                _project: function () {},
                _update: function () {}
            });

            Atlas.Polyline = Atlas.Path.extend({
                options: {
                    smoothFactor: 1.0,
                    noClip: false
                },
                initialize: function (latlngs, options) {
                    Atlas.Util.setOptions(this, options);
                    this._setLatLngs(latlngs);
                },
                _setLatLngs: function (latlngs) {
                    this._latlngs = this._convertLatLngs(latlngs);
                },
                _convertLatLngs: function (latlngs) {
                    var result = [],
                        flat = Atlas.Util.isArray(latlngs[0]);
                    for (var i = 0, len = latlngs.length; i < len; i++) {
                        if (flat) {
                            result[i] = Atlas.latLng(latlngs[i]);
                        } else {
                            result[i] = this._convertLatLngs(latlngs[i]);
                        }
                    }
                    return result;
                },
                getLatLngs: function () {
                    return this._latlngs;
                },
                setLatLngs: function (latlngs) {
                    this._setLatLngs(latlngs);
                    return this.redraw();
                },
                isEmpty: function () {
                    return !this._latlngs.length;
                },
                getCenter: function () {
                    if (!this._latlngs.length) {
                        throw new Error('Must have at least one latlng in the polyline.');
                    }
                    var i, halfDist, segDist, dist, p1, p2, ratio,
                        points = this._getProjectedPoints(),
                        len = points.length;
                    if (!len) { return null; }
                    var latSum = 0, lngSum = 0;
                    for (i = 0; i < len; i++) {
                        var latlng = this._latlngs[i];
                        latSum += latlng.lat;
                        lngSum += latlng.lng;
                    }
                    return new Atlas.LatLng(latSum / len, lngSum / len);
                },
                getBounds: function () {
                    var bounds = new Atlas.LatLngBounds();
                    var latLngs = this.getLatLngs();
                    for (var i = 0, len = latLngs.length; i < len; i++) {
                        bounds.extend(latLngs[i]);
                    }
                    return bounds;
                },
                _project: function () {
                    this._rings = [];
                    this._projectLatlngs(this._latlngs, this._rings);
                },
                _projectLatlngs: function (latlngs, result) {
                    var flat = latlngs[0] instanceof Atlas.LatLng,
                        len = latlngs.length,
                        i, ring;
                    if (flat) {
                        ring = [];
                        for (i = 0; i < len; i++) {
                            ring[i] = this._map.latLngToLayerPoint(latlngs[i]);
                        }
                        result.push(ring);
                    } else {
                        for (i = 0; i < len; i++) {
                            this._projectLatlngs(latlngs[i], result);
                        }
                    }
                },
                _update: function () {
                    if (!this._map) { return; }
                    this._renderer._updatePoly(this);
                },
                _getProjectedPoints: function () {
                    return this._rings[0];
                }
            });

            Atlas.Polygon = Atlas.Polyline.extend({
                options: {
                    fill: true
                },
                isEmpty: function () {
                    return !this._latlngs.length || !this._latlngs[0].length;
                },
                getCenter: function () {
                    var latSum = 0, lngSum = 0;
                    var points = this._getProjectedPoints();
                    if (!points.length) { return null; }
                    for (var i = 0; i < points.length; i++) {
                        var latlng = this._map.layerPointToLatLng(points[i]);
                        latSum += latlng.lat;
                        lngSum += latlng.lng;
                    }
                    return new Atlas.LatLng(latSum / points.length, lngSum / points.length);
                },
                _update: function () {
                    if (!this._map) { return; }
                    this._renderer._updatePoly(this, true);
                }
            });

            Atlas.Circle = Atlas.Path.extend({
                options: {
                    fill: true,
                    radius: 10
                },
                initialize: function (latlng, options) {
                    Atlas.Util.setOptions(this, options);
                    this._latlng = Atlas.latLng(latlng);
                    if (isNaN(this.options.radius)) { throw new Error('Circle radius cannot be NaN'); }
                },
                setLatLng: function (latlng) {
                    this._latlng = Atlas.latLng(latlng);
                    return this.redraw();
                },
                getLatLng: function () {
                    return this._latlng;
                },
                setRadius: function (radius) {
                    this.options.radius = this._radius = radius;
                    return this.redraw();
                },
                getRadius: function () {
                    return this._radius;
                },
                getBounds: function () {
                    var halfSize = new Atlas.Point(this._radius, this._radius);
                    return new Atlas.LatLngBounds(
                        this._map.layerPointToLatLng(this._point.subtract(halfSize)),
                        this._map.layerPointToLatLng(this._point.add(halfSize))
                    );
                },
                _project: function () {
                    this._point = this._map.latLngToLayerPoint(this._latlng);
                    this._radius = this._map.getZoomScale(this._map.getZoom()) * this.options.radius;
                },
                _update: function () {
                    if (this._map) {
                        this._renderer._updateCircle(this);
                    }
                }
            });

            Atlas.Rectangle = Atlas.Polygon.extend({
                initialize: function (latLngBounds, options) {
                    Atlas.Polygon.prototype.initialize.call(this, this._boundsToLatLngs(latLngBounds), options);
                },
                setBounds: function (latLngBounds) {
                    this.setLatLngs(this._boundsToLatLngs(latLngBounds));
                    return this;
                },
                _boundsToLatLngs: function (bounds) {
                    bounds = Atlas.latLngBounds(bounds);
                    return [
                        bounds.getSouthWest(),
                        bounds.getNorthWest(),
                        bounds.getNorthEast(),
                        bounds.getSouthEast(),
                        bounds.getSouthWest()
                    ];
                }
            });

            Atlas.Renderer = Atlas.Class.extend({
                includes: Atlas.Events,
                options: {
                    padding: 0.1
                },
                initialize: function (options) {
                    Atlas.Util.setOptions(this, options);
                    Atlas.stamp(this);
                    this._layers = this._layers || {};
                },
                onAdd: function () {
                    if (!this._container) {
                        this._initContainer();
                    }
                    this.getPane().appendChild(this._container);
                    if (this.options.zoomAnimation) {
                        this._animatingZoom = true;
                        Atlas.DomUtil.addClass(this._container, 'atlas-zoom-animated');
                    }
                },
                onRemove: function () {
                    Atlas.DomUtil.remove(this._container);
                },
                getEvents: function () {
                    var events = {
                        viewreset: this._reset,
                        zoom: this._onZoom,
                        moveend: this._update
                    };
                    if (this._zoomAnimated) {
                        events.zoomanim = this._onAnimZoom;
                    }
                    return events;
                },
                _onAnimZoom: function (ev) {
                    this._updateTransform(ev.center, ev.zoom);
                },
                _onZoom: function () {
                    this._updateTransform(this._map.getCenter(), this._map.getZoom());
                },
                _updateTransform: function (center, zoom) {
                    var scale = this._map.getZoomScale(zoom, this._zoom),
                        position = this._map.latLngToLayerPoint(center)._subtract(this._map._getCenterLayerPoint())._multiplyBy(-scale)._add(this._map._getMapPanePos());
                    Atlas.DomUtil.setTransform(this._container, position, scale);
                },
                _reset: function () {
                    this._update();
                    this.fire('update');
                },
                _update: function () {},
                addLayer: function (layer) {
                    var id = Atlas.Util.stamp(layer);
                    this._layers[id] = layer;
                    if (this._map) {
                        this._reset();
                        layer._renderer = this;
                    }
                    return this;
                },
                removeLayer: function (layer) {
                    var id = Atlas.Util.stamp(layer);
                    if (this._layers[id]) {
                        this._layers[id] = null;
                        delete this._layers[id];
                        if (this._map) {
                            this._update();
                        }
                    }
                    return this;
                }
            });

            Atlas.SVG = Atlas.Renderer.extend({
                getEvents: function () {
                    var events = Atlas.Renderer.prototype.getEvents.call(this);
                    events.zoomstart = this._onZoomStart;
                    return events;
                },
                _onZoomStart: function () {
                    this._update();
                },
                _initContainer: function () {
                    this._container = Atlas.DomUtil.create('svg', 'atlas-zoom-animated');
                    this._container.setAttribute('pointer-events', 'none');
                    this._rootGroup = Atlas.DomUtil.create('g', '', this._container);
                },
                _update: function () {
                    if (this._map._animatingZoom && !Atlas.Browser.gecko) {
                        return;
                    }
                    Atlas.Renderer.prototype._update.call(this);
                    var b = this._map.getPixelBounds(), size = this._map.getSize(),
                        pos = b.min.subtract(new Atlas.Point(size.x * 0.5, size.y * 0.5));
                    Atlas.DomUtil.setPosition(this._container, pos);
                    this._container.setAttribute('width', size.x * 2);
                    this._container.setAttribute('height', size.y * 2);
                    this._container.setAttribute('viewBox', [pos.x, pos.y, size.x * 2, size.y * 2].join(' '));
                    this._rootGroup.setAttribute('transform', 'translate(' + (-pos.x) + ',' + (-pos.y) + ')');
                },
                _animateZoom: function(e) {
                    var scale = e.scale, origin = e.origin;
                    var offset = origin.multiplyBy(1/scale).subtract(origin);
                    this._rootGroup.setAttribute('transform', 'translate(' + offset.x + ',' + offset.y + ') scale(' + scale + ')');
                },
                statics: {
                    create: function (name) {
                        return document.createElementNS('http://www.w3.org/2000/svg', name);
                    },
                    pointsToPath: function (rings, closed) {
                        var str = '',
                            i, j, len, len2, points, p;
                        for (i = 0, len = rings.length; i < len; i++) {
                            points = rings[i];
                            for (j = 0, len2 = points.length; j < len2; j++) {
                                p = points[j];
                                str += (j ? 'L' : 'M') + p.x + ' ' + p.y;
                            }
                            str += closed ? 'Z' : '';
                        }
                        return str || 'M0 0';
                    }
                }
            });

            Atlas.svg = function (options) {
                return new Atlas.SVG(options);
            };

            Atlas.Draggable = Atlas.Class.extend({
                includes: Atlas.Events,
                statics: {
                    START: Atlas.Browser.touch ? ['touchstart', 'mousedown'] : ['mousedown'],
                    END: {
                        mousedown: 'mouseup',
                        touchstart: 'touchend',
                        pointerdown: 'touchend',
                        MSPointerDown: 'touchend'
                    },
                    MOVE: {
                        mousedown: 'mousemove',
                        touchstart: 'touchmove',
                        pointerdown: 'touchmove',
                        MSPointerDown: 'touchmove'
                    }
                },
                initialize: function (element, dragStartTarget, preventOutline) {
                    this._element = element;
                    this._dragStartTarget = dragStartTarget || element;
                    this._preventOutline = preventOutline;
                },
                enable: function () {
                    if (this._enabled) { return; }
                    Atlas.DomEvent.on(this._dragStartTarget, 'mousedown touchstart', this._onDown, this);
                    this._enabled = true;
                },
                disable: function () {
                    if (!this._enabled) { return; }
                    Atlas.DomEvent.off(this._dragStartTarget, 'mousedown touchstart', this._onDown, this);
                    this._enabled = false;
                    this._moved = false;
                },
                _onDown: function (e) {
                    if (e.shiftKey || ((e.which !== 1) && (e.button !== 1) && !e.touches)) { return; }
                    if (this._moved) { return; }
                    if (Atlas.DomUtil.hasClass(this._element, 'atlas-zoom-anim')) { return; }
                    if (this._preventOutline) {
                        Atlas.DomUtil.preventOutline(this._element);
                    }
                    Atlas.DomUtil.disableImageDrag();
                    Atlas.DomUtil.disableTextSelection();
                    this._moved = false;
                    var first = e.touches ? e.touches[0] : e;
                    this._startPoint = new Atlas.Point(first.clientX, first.clientY);
                    this._startPos = Atlas.DomUtil.getPosition(this._element);
                    Atlas.DomEvent.on(document, Atlas.Draggable.MOVE[e.type], this._onMove, this);
                    Atlas.DomEvent.on(document, Atlas.Draggable.END[e.type], this._onUp, this);
                },
                _onMove: function (e) {
                    if (e.touches && e.touches.length > 1) {
                        this._moved = true;
                        return;
                    }
                    var first = (e.touches && e.touches.length === 1 ? e.touches[0] : e),
                        newPoint = new Atlas.Point(first.clientX, first.clientY),
                        offset = newPoint.subtract(this._startPoint);
                    if (!offset.x && !offset.y) { return; }
                    if (Math.abs(offset.x) + Math.abs(offset.y) < 3) { return; }
                    Atlas.DomEvent.preventDefault(e);
                    if (!this._moved) {
                        this.fire('dragstart');
                        this._moved = true;
                        Atlas.DomUtil.addClass(document.body, 'atlas-dragging');
                        this._lastTarget = e.target || e.srcElement;
                        if (window.SVGElementInstance && this._lastTarget instanceof window.SVGElementInstance) {
                            this._lastTarget = this._lastTarget.correspondingUseElement;
                        }
                        Atlas.DomUtil.addClass(this._lastTarget, 'atlas-drag-target');
                    }
                    this._newPos = this._startPos.add(offset);
                    this._moving = true;
                    Atlas.Util.cancelAnimFrame(this._animRequest);
                    this._animRequest = Atlas.Util.requestAnimFrame(this._updatePosition, this, true, this._dragStartTarget);
                },
                _updatePosition: function () {
                    this.fire('predrag');
                    Atlas.DomUtil.setPosition(this._element, this._newPos);
                    this.fire('drag');
                },
                _onUp: function () {
                    Atlas.DomUtil.removeClass(document.body, 'atlas-dragging');
                    if (this._lastTarget) {
                        Atlas.DomUtil.removeClass(this._lastTarget, 'atlas-drag-target');
                        this._lastTarget = null;
                    }
                    for (var i in Atlas.Draggable.MOVE) {
                        Atlas.DomEvent.off(document, Atlas.Draggable.MOVE[i], this._onMove, this);
                        Atlas.DomEvent.off(document, Atlas.Draggable.END[i], this._onUp, this);
                    }
                    Atlas.DomUtil.enableImageDrag();
                    Atlas.DomUtil.enableTextSelection();
                    if (this._moved && this._moving) {
                        Atlas.Util.cancelAnimFrame(this._animRequest);
                        this._moving = false;
                        this.fire('dragend', {
                            distance: this._newPos.distanceTo(this._startPos)
                        });
                    }
                    this._moved = false;
                }
            });

            Atlas.Handler = Atlas.Class.extend({
                initialize: function (map) {
                    this._map = map;
                },
                enable: function () {
                    if (this._enabled) { return this; }
                    this._enabled = true;
                    this.addHooks();
                    return this;
                },
                disable: function () {
                    if (!this._enabled) { return this; }
                    this._enabled = false;
                    this.removeHooks();
                    return this;
                },
                enabled: function () {
                    return !!this._enabled;
                }
            });

            Atlas.Handler.MapDrag = Atlas.Handler.extend({
                addHooks: function () {
                    if (!this._draggable) {
                        var map = this._map;
                        this._draggable = new Atlas.Draggable(map._mapPane, map._container);
                        this._draggable.on({
                            'dragstart': this._onDragStart,
                            'drag': this._onDrag,
                            'dragend': this._onDragEnd
                        }, this);
                    }
                    Atlas.DomUtil.addClass(this._map._container, 'atlas-grab atlas-touching');
                    this._draggable.enable();
                    this._positions = [];
                    this._times = [];
                },
                removeHooks: function () {
                    Atlas.DomUtil.removeClass(this._map._container, 'atlas-grab');
                    Atlas.DomUtil.removeClass(this._map._container, 'atlas-touching');
                    this._draggable.disable();
                },
                moved: function () {
                    return this._draggable && this._draggable._moved;
                },
                _onDragStart: function () {
                    var map = this._map;
                    map._stop();
                    if (this._map.options.maxBounds && this._map.options.maxBoundsViscosity) {
                        var bounds = Atlas.latLngBounds(this._map.options.maxBounds);
                        this._offsetLimit = Atlas.bounds(
                            this._map.latLngToContainerPoint(bounds.getNorthWest()).multiplyBy(-1),
                            this._map.latLngToContainerPoint(bounds.getSouthEast()).multiplyBy(-1)
                                .add(this._map.getSize()));
                        this._viscosity = Math.min(1.0, Math.max(0.0, this._map.options.maxBoundsViscosity));
                    } else {
                        this._offsetLimit = null;
                    }
                    map.fire('movestart').fire('dragstart');
                    if (map.options.inertia) {
                        this._positions = [];
                        this._times = [];
                    }
                },
                _onDrag: function (e) {
                    if (this._map.options.inertia) {
                        var time = this._lastTime = +new Date(),
                            pos = this._lastPos = this._draggable._newPos;
                        this._positions.push(pos);
                        this._times.push(time);
                        if (time - this._times[0] > 50) {
                            this._positions.shift();
                            this._times.shift();
                        }
                    }
                    this._map
                        .fire('move', e)
                        .fire('drag', e);
                },
                _onDragEnd: function (e) {
                    var map = this._map,
                        options = map.options,
                        noInertia = !options.inertia || this._times.length < 2;
                    map.fire('dragend', e);
                    if (noInertia) {
                        map.fire('moveend');
                    } else {
                        var direction = this._lastPos.subtract(this._positions[0]),
                            duration = (this._lastTime - this._times[0]) / 1000,
                            ease = options.easeLinearity,
                            speedVector = direction.multiplyBy(ease / duration),
                            speed = speedVector.distanceTo(new Atlas.Point(0, 0)),
                            limitedSpeed = Math.min(options.inertiaMaxSpeed, speed),
                            limitedSpeedVector = speedVector.multiplyBy(limitedSpeed / speed),
                            decelerationDuration = limitedSpeed / (options.inertiaDeceleration * ease),
                            offset = limitedSpeedVector.multiplyBy(-decelerationDuration / 2).round();
                        if (!offset.x && !offset.y) {
                            map.fire('moveend');
                        } else {
                            offset = map._limitOffset(offset, this._offsetLimit || map.options.maxBounds);
                            Atlas.Util.requestAnimFrame(function () {
                                map.panBy(offset, {
                                    duration: decelerationDuration,
                                    easeLinearity: ease,
                                    noMoveStart: true,
                                    animate: true
                                });
                            });
                        }
                    }
                }
            });

            Atlas.Handler.DoubleClickZoom = Atlas.Handler.extend({
                addHooks: function () {
                    this._map.on('dblclick', this._onDoubleClick, this);
                },
                removeHooks: function () {
                    this._map.off('dblclick', this._onDoubleClick, this);
                },
                _onDoubleClick: function (e) {
                    var map = this._map,
                        zoom = map.getZoom() + (e.originalEvent.shiftKey ? -1 : 1);
                    if (map.options.doubleClickZoom === 'center') {
                        map.setZoom(zoom);
                    } else {
                        map.setZoomAround(e.containerPoint, zoom);
                    }
                }
            });

            Atlas.Handler.ScrollWheelZoom = Atlas.Handler.extend({
                addHooks: function () {
                    Atlas.DomEvent.on(this._map._container, 'wheel', this._onWheelScroll, this);
                    this._delta = 0;
                },
                removeHooks: function () {
                    Atlas.DomEvent.off(this._map._container, 'wheel', this._onWheelScroll, this);
                },
                _onWheelScroll: function (e) {
                    var delta = Atlas.DomEvent.getWheelDelta(e);
                    var debounce = this._map.options.wheelDebounceTime;
                    this._delta += delta;
                    this._lastMousePos = this._map.mouseEventToContainerPoint(e);
                    if (!this._startTime) {
                        this._startTime = +new Date();
                    }
                    var left = Math.max(debounce - (+new Date() - this._startTime), 0);
                    clearTimeout(this._timer);
                    this._timer = setTimeout(Atlas.Util.bind(this._performZoom, this), left);
                    Atlas.DomEvent.stop(e);
                },
                _performZoom: function () {
                    var map = this._map,
                        zoom = map.getZoom(),
                        snap = map.options.zoomSnap || 0;
                    map._stop();
                    var d = this._delta / (this._map.options.wheelPxPerZoomLevel * 4);
                    this._delta = 0;
                    this._startTime = null;
                    if (!d) { return; }
                    if (map.options.scrollWheelZoom === 'center') {
                        map.setZoom(zoom + (d > 0 ? Math.ceil(d) : Math.floor(d)));
                    } else {
                        map.setZoomAround(this._lastMousePos, zoom + d);
                    }
                }
            });

            Atlas.Handler.Keyboard = Atlas.Handler.extend({
                keyCodes: {
                    left:    [37],
                    right:   [39],
                    down:    [40],
                    up:      [38],
                    zoomIn:  [187, 107, 61, 171],
                    zoomOut: [189, 109, 173]
                },
                initialize: function (map) {
                    this._map = map;
                    this._setPanDelta(map.options.keyboardPanDelta);
                    this._setZoomDelta(map.options.zoomDelta);
                },
                addHooks: function () {
                    var container = this._map._container;
                    if (container.tabIndex <= 0) {
                        container.tabIndex = '0';
                    }
                    Atlas.DomEvent.on(container, {
                        focus: this._onFocus,
                        blur: this._onBlur,
                        mousedown: this._onMouseDown,
                        keydown: this._onKeyDown,
                        keyup: this._onKeyUp
                    }, this);
                    this._map.on('focus', this._addHooks, this);
                    this._map.on('blur', this._removeHooks, this);
                },
                removeHooks: function () {
                    this._removeHooks();
                    var container = this._map._container;
                    Atlas.DomEvent.off(container, {
                        focus: this._onFocus,
                        blur: this._onBlur,
                        mousedown: this._onMouseDown,
                        keydown: this._onKeyDown,
                        keyup: this._onKeyUp
                    }, this);
                    this._map.off('focus', this._addHooks, this);
                    this._map.off('blur', this._removeHooks, this);
                },
                _onMouseDown: function () {
                    if (this._focused) { return; }
                    var body = document.body,
                        docEl = document.documentElement,
                        top = body.scrollTop || docEl.scrollTop,
                        left = body.scrollLeft || docEl.scrollLeft;
                    this._map._container.focus();
                    window.scrollTo(left, top);
                },
                _onFocus: function () {
                    this._focused = true;
                    this._map.fire('focus');
                },
                _onBlur: function () {
                    this._focused = false;
                    this._map.fire('blur');
                },
                _setPanDelta: function (panDelta) {
                    var keys = this.keyCodes,
                        panKeys = {
                            left: keys.left,
                            right: keys.right,
                            down: keys.down,
                            up: keys.up
                        };
                    this._map.options.keyboardPanDelta = panDelta;
                    this._panKeys = {};
                    for (var direction in panKeys) {
                        panKeys[direction].forEach(function (code) {
                            this._panKeys[code] = direction;
                        }, this);
                    }
                },
                _setZoomDelta: function (zoomDelta) {
                    var keys = this.keyCodes,
                        zoomKeys = {zoomIn: keys.zoomIn, zoomOut: keys.zoomOut};
                    this._zoomKeys = {};
                    for (var dir in zoomKeys) {
                        zoomKeys[dir].forEach(function (code) {
                            this._zoomKeys[code] = dir;
                        }, this);
                    }
                },
                _addHooks: function () {
                    Atlas.DomEvent.on(document, 'keydown', this._onKeyDown, this);
                },
                _removeHooks: function () {
                    Atlas.DomEvent.off(document, 'keydown', this._onKeyDown, this);
                },
                _onKeyDown: function (e) {
                    if (e.altKey || e.ctrlKey || e.metaKey) { return; }
                    var key = e.keyCode,
                        map = this._map,
                        offset;
                    if (key in this._panKeys) {
                        if (!map._panAnim || !map._panAnim._inProgress) {
                            offset = this._map.options.keyboardPanDelta;
                            if (key === this.keyCodes.left) {
                                offset = new Atlas.Point(-offset, 0);
                            } else if (key === this.keyCodes.right) {
                                offset = new Atlas.Point(offset, 0);
                            } else if (key === this.keyCodes.down) {
                                offset = new Atlas.Point(0, offset);
                            } else if (key === this.keyCodes.up) {
                                offset = new Atlas.Point(0, -offset);
                            }
                            map.panBy(offset);
                        }
                    } else if (key in this._zoomKeys) {
                        map.setZoom(map.getZoom() + (key === this.keyCodes.zoomIn ? 1 : -1));
                    } else if (key === 27 && map._popup && map._popup.options.closeOnEscapeKey) {
                        map.closePopup();
                    } else {
                        return;
                    }
                    Atlas.DomEvent.stop(e);
                }
            });

            Atlas.Control = Atlas.Class.extend({
                options: {
                    position: 'topright'
                },
                initialize: function (options) {
                    Atlas.Util.setOptions(this, options);
                },
                setPosition: function (position) {
                    var map = this._map;
                    if (map) {
                        map.removeControl(this);
                    }
                    this.options.position = position;
                    if (map) {
                        map.addControl(this);
                    }
                    return this;
                },
                getPosition: function () {
                    return this.options.position;
                },
                addTo: function (map) {
                    this._map = map;
                    var container = this._container = this.onAdd(map),
                        pos = this.getPosition(),
                        corner = map._controlContainer;
                    var className = 'atlas-control-' + pos;
                    var container = corner.querySelector('.' + className);
                    if (!container) {
                        container = Atlas.DomUtil.create('div', className, corner);
                    }
                    container.appendChild(this._container);
                    return this;
                },
                remove: function () {
                    if (this._map) {
                        this._map.removeControl(this);
                    }
                    Atlas.DomUtil.remove(this._container);
                    if (this.onRemove) {
                        this.onRemove(this._map);
                    }
                    this._map = null;
                    return this;
                },
                _refocusOnMap: function (e) {
                    if (this._map && e && e.screenX) {
                        this._map.getContainer().focus();
                    }
                }
            });

            Atlas.Control.Zoom = Atlas.Control.extend({
                options: {
                    position: 'topleft',
                    zoomInText: '+',
                    zoomInTitle: 'Zoom in',
                    zoomOutText: '-',
                    zoomOutTitle: 'Zoom out'
                },
                onAdd: function (map) {
                    var zoomName = 'atlas-control-zoom',
                        container = Atlas.DomUtil.create('div', zoomName + ' atlas-bar atlas-control');
                    this._zoomInButton  = this._createButton(
                        this.options.zoomInText, this.options.zoomInTitle,
                        zoomName + '-in',  container, this._zoomIn);
                    this._zoomOutButton = this._createButton(
                        this.options.zoomOutText, this.options.zoomOutTitle,
                        zoomName + '-out', container, this._zoomOut);
                    this._updateDisabled();
                    map.on('zoomend zoomlevelschange', this._updateDisabled, this);
                    return container;
                },
                onRemove: function (map) {
                    map.off('zoomend zoomlevelschange', this._updateDisabled, this);
                },
                disable: function () {
                    this._disabled = true;
                    this._updateDisabled();
                    return this;
                },
                enable: function () {
                    this._disabled = false;
                    this._updateDisabled();
                    return this;
                },
                _zoomIn: function (e) {
                    if (!this._disabled && this._map._zoom < this._map.getMaxZoom()) {
                        this._map.zoomIn(this._map.options.zoomDelta);
                    }
                },
                _zoomOut: function (e) {
                    if (!this._disabled && this._map._zoom > this._map.getMinZoom()) {
                        this._map.zoomOut(this._map.options.zoomDelta);
                    }
                },
                _createButton: function (html, title, className, container, fn) {
                    var link = Atlas.DomUtil.create('a', className, container);
                    link.innerHTML = html;
                    link.href = '#';
                    link.title = title;
                    link.role = 'button';
                    link.setAttribute('aria-label', title);
                    Atlas.DomEvent.disableClickPropagation(link);
                    Atlas.DomEvent.on(link, 'click', Atlas.DomEvent.stopPropagation);
                    Atlas.DomEvent.on(link, 'click', fn, this);
                    Atlas.DomEvent.on(link, 'click', this._refocusOnMap, this);
                    return link;
                },
                _updateDisabled: function () {
                    var map = this._map,
                        className = 'atlas-disabled';
                    Atlas.DomUtil.removeClass(this._zoomInButton, className);
                    Atlas.DomUtil.removeClass(this._zoomOutButton, className);
                    if (this._disabled || map._zoom === map.getMinZoom()) {
                        Atlas.DomUtil.addClass(this._zoomOutButton, className);
                    }
                    if (this._disabled || map._zoom === map.getMaxZoom()) {
                        Atlas.DomUtil.addClass(this._zoomInButton, className);
                    }
                }
            });

            Atlas.Control.Attribution = Atlas.Control.extend({
                options: {
                    position: 'bottomright',
                    prefix: '<a href="https://github.com/Leaflet/Leaflet" title="A JS library for interactive maps">Leaflet</a>'
                },
                initialize: function (options) {
                    Atlas.Util.setOptions(this, options);
                    this._attributions = {};
                },
                onAdd: function (map) {
                    this._container = Atlas.DomUtil.create('div', 'atlas-control-attribution atlas-control');
                    Atlas.DomEvent.disableClickPropagation(this._container);
                    for (var i in map._layers) {
                        if (map._layers[i].getAttribution) {
                            this.addAttribution(map._layers[i].getAttribution());
                        }
                    }
                    map.on('layeradd', this._onLayerAdd, this);
                    map.on('layerremove', this._onLayerRemove, this);
                    this._update();
                    return this._container;
                },
                onRemove: function (map) {
                    map.off('layeradd', this._onLayerAdd);
                    map.off('layerremove', this._onLayerRemove);
                },
                setPrefix: function (prefix) {
                    this.options.prefix = prefix;
                    this._update();
                    return this;
                },
                addAttribution: function (text) {
                    if (!text) { return this; }
                    if (!this._attributions[text]) {
                        this._attributions[text] = 0;
                    }
                    this._attributions[text]++;
                    this._update();
                    return this;
                },
                removeAttribution: function (text) {
                    if (!text) { return this; }
                    if (this._attributions[text]) {
                        this._attributions[text]--;
                        this._update();
                    }
                    return this;
                },
                _update: function () {
                    if (!this._map) { return; }
                    var attribs = [];
                    for (var i in this._attributions) {
                        if (this._attributions[i]) {
                            attribs.push(i);
                        }
                    }
                    var prefixAndAttribs = [];
                    if (this.options.prefix) {
                        prefixAndAttribs.push(this.options.prefix);
                    }
                    if (attribs.length) {
                        prefixAndAttribs.push(attribs.join(', '));
                    }
                    this._container.innerHTML = prefixAndAttribs.join(' | ');
                },
                _onLayerAdd: function (e) {
                    if (e.layer.getAttribution) {
                        this.addAttribution(e.layer.getAttribution());
                    }
                },
                _onLayerRemove: function (e) {
                    if (e.layer.getAttribution) {
                        this.removeAttribution(e.layer.getAttribution());
                    }
                }
            });

            Atlas.Control.Scale = Atlas.Control.extend({
                options: {
                    position: 'bottomleft',
                    maxWidth: 100,
                    metric: true,
                    imperial: true
                },
                onAdd: function (map) {
                    var className = 'atlas-control-scale',
                        container = Atlas.DomUtil.create('div', className),
                        options = this.options;
                    this._addScales(options, className + '-line', container);
                    map.on(options.updateWhenIdle ? 'moveend' : 'move', this._update, this);
                    this._update();
                    return container;
                },
                onRemove: function (map) {
                    map.off(this.options.updateWhenIdle ? 'moveend' : 'move', this._update, this);
                },
                _addScales: function (options, className, container) {
                    if (options.metric) {
                        this._mScale = Atlas.DomUtil.create('div', className, container);
                    }
                    if (options.imperial) {
                        this._iScale = Atlas.DomUtil.create('div', className, container);
                    }
                },
                _update: function () {
                    var bounds = this._map.getBounds(),
                        centerLat = bounds.getCenter().lat,
                        halfWorldMeters = 6378137 * Math.PI * Math.cos(centerLat * Math.PI / 180),
                        dist = halfWorldMeters * (bounds.getNorthEast().lng - bounds.getSouthWest().lng) / 180,
                        size = this._map.getSize(),
                        options = this.options,
                        maxMeters = 0;
                    if (size.x > 0) {
                        maxMeters = dist * (options.maxWidth / size.x);
                    }
                    this._updateScales(options, maxMeters);
                },
                _updateScales: function (options, maxMeters) {
                    if (options.metric && maxMeters) {
                        this._updateMetric(maxMeters);
                    }
                    if (options.imperial && maxMeters) {
                        this._updateImperial(maxMeters);
                    }
                },
                _updateMetric: function (maxMeters) {
                    var meters = this._getRoundNum(maxMeters),
                        label = meters < 1000 ? meters + ' m' : (meters / 1000) + ' km';
                    this._updateScale(this._mScale, label, meters / maxMeters);
                },
                _updateImperial: function (maxMeters) {
                    var maxFeet = maxMeters * 3.2808399,
                        scale = this._iScale,
                        maxMiles, miles, feet;
                    if (maxFeet > 5280) {
                        maxMiles = maxFeet / 5280;
                        miles = this._getRoundNum(maxMiles);
                        this._updateScale(scale, miles + ' mi', miles / maxMiles);
                    } else {
                        feet = this._getRoundNum(maxFeet);
                        this._updateScale(scale, feet + ' ft', feet / maxFeet);
                    }
                },
                _updateScale: function (scale, text, ratio) {
                    scale.style.width = Math.round(this.options.maxWidth * ratio) + 'px';
                    scale.innerHTML = text;
                },
                _getRoundNum: function (num) {
                    var pow10 = Math.pow(10, (Math.floor(num) + '').length - 1),
                        d = num / pow10;
                    d = d >= 10 ? 10 : d >= 5 ? 5 : d >= 3 ? 3 : d >= 2 ? 2 : 1;
                    return pow10 * d;
                }
            });

            Atlas.LayerGroup = Atlas.Class.extend({
                initialize: function (layers) {
                    this._layers = {};
                    var i, len;
                    if (layers) {
                        for (i = 0, len = layers.length; i < len; i++) {
                            this.addLayer(layers[i]);
                        }
                    }
                },
                addLayer: function (layer) {
                    var id = this.getLayerId(layer);
                    this._layers[id] = layer;
                    if (this._map) {
                        this._map.addLayer(layer);
                    }
                    return this;
                },
                removeLayer: function (layer) {
                    var id = layer in this._layers ? layer : this.getLayerId(layer);
                    if (this._map && this._layers[id]) {
                        this._map.removeLayer(this._layers[id]);
                    }
                    delete this._layers[id];
                    return this;
                },
                hasLayer: function (layer) {
                    return !!layer && (layer in this._layers || this.getLayerId(layer) in this._layers);
                },
                clearLayers: function () {
                    for (var i in this._layers) {
                        this.removeLayer(this._layers[i]);
                    }
                    return this;
                },
                invoke: function (methodName) {
                    var args = Array.prototype.slice.call(arguments, 1),
                        i, layer;
                    for (i in this._layers) {
                        layer = this._layers[i];
                        if (layer[methodName]) {
                            layer[methodName].apply(layer, args);
                        }
                    }
                    return this;
                },
                onAdd: function (map) {
                    this._map = map;
                    this.eachLayer(map.addLayer, map);
                },
                onRemove: function (map) {
                    this.eachLayer(map.removeLayer, map);
                    this._map = null;
                },
                eachLayer: function (method, context) {
                    for (var i in this._layers) {
                        method.call(context, this._layers[i]);
                    }
                    return this;
                },
                getLayer: function (id) {
                    return this._layers[id];
                },
                getLayers: function () {
                    var layers = [];
                    this.eachLayer(layers.push, layers);
                    return layers;
                },
                setZIndex: function (zIndex) {
                    return this.invoke('setZIndex', zIndex);
                },
                getLayerId: Atlas.Util.stamp
            });

            Atlas.FeatureGroup = Atlas.LayerGroup.extend({
                addLayer: function (layer) {
                    if (this.hasLayer(layer)) {
                        return this;
                    }
                    layer.addEventParent(this);
                    Atlas.LayerGroup.prototype.addLayer.call(this, layer);
                    return this.fire('layeradd', {layer: layer});
                },
                removeLayer: function (layer) {
                    if (!this.hasLayer(layer)) {
                        return this;
                    }
                    if (layer in this._layers) {
                        layer = this._layers[layer];
                    }
                    layer.removeEventParent(this);
                    Atlas.LayerGroup.prototype.removeLayer.call(this, layer);
                    return this.fire('layerremove', {layer: layer});
                },
                setStyle: function (style) {
                    return this.invoke('setStyle', style);
                },
                bringToFront: function () {
                    return this.invoke('bringToFront');
                },
                bringToBack: function () {
                    return this.invoke('bringToBack');
                },
                getBounds: function () {
                    var bounds = new Atlas.LatLngBounds();
                    for (var id in this._layers) {
                        var layer = this._layers[id];
                        bounds.extend(layer.getBounds ? layer.getBounds() : layer.getLatLng());
                    }
                    return bounds;
                }
            });

            Atlas.geoJSON = function (geojson, options) {
                return new Atlas.GeoJSON(geojson, options);
            };

            Atlas.geoJson = Atlas.geoJSON;

            Atlas.layerGroup = function (layers) {
                return new Atlas.LayerGroup(layers);
            };

            Atlas.featureGroup = function (layers) {
                return new Atlas.FeatureGroup(layers);
            };

            Atlas.polyline = function (latlngs, options) {
                return new Atlas.Polyline(latlngs, options);
            };

            Atlas.polygon = function (latlngs, options) {
                return new Atlas.Polygon(latlngs, options);
            };

            Atlas.rectangle = function (latLngBounds, options) {
                return new Atlas.Rectangle(latLngBounds, options);
            };

            Atlas.circle = function (latlng, options) {
                return new Atlas.Circle(latlng, options);
            };

            Atlas.imageOverlay = function (url, bounds, options) {
                return new Atlas.ImageOverlay(url, bounds, options);
            };

            Atlas.videoOverlay = function (url, bounds, options) {
                return new Atlas.VideoOverlay(url, bounds, options);
            };

            Atlas.svgOverlay = function (element, bounds, options) {
                return new Atlas.SVGOverlay(element, bounds, options);
            };

            expose();
        })(window, document);

        var map = Atlas.map('map').setView([31.7917, -7.0926], 6);
        Atlas.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    </script>
</body>
</html>

